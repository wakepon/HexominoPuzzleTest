# ゲームメカニクス

## 概要

ブロック配置パズルのコアメカニクス（ボード管理、ブロック配置、衝突判定、デッキシステム、ラウンド制、ショップ）について説明する。

## ボード管理

### ボード構造

- 6x6のグリッド（`GRID_SIZE = 6`）
- 各セルは `Cell` 型で表現される
  - `filled: boolean` - セルが埋まっているかどうか

### 空ボード生成

- ゲーム開始時とラウンド開始時に全セルが空の状態でボードが生成される
- すべてのセルの `filled` が `false` で初期化される

### セル状態の取得

- 指定位置のセルを取得する機能
- 範囲外の座標を指定した場合は `null` を返す

## デッキシステム

### デッキの構成

- デッキは複数のミノIDから構成される
- 初期デッキは定義済みのミノIDリストから作成される
- ショップで購入したミノがデッキに追加される

### デッキの初期化

- ゲーム開始時に初期デッキミノIDリストが取得される
- Fisher-Yatesアルゴリズムでシャッフルされる
- 配置可能回数が初期値に設定される

### ミノの引き出し

- デッキから指定枚数（通常3枚）のミノIDを引く
- デッキが足りない場合は初期ミノIDリストを再シャッフルして補充
- 引いたミノIDからPieceオブジェクトを生成

### ミノID→Piece変換

- ミノIDから対応するMinoDefinitionを取得
- タイムスタンプと乱数でユニークなPiece IDを生成
- MinoDefinitionの形状を継承してPieceを作成

### 残り配置回数

- ラウンド開始時に配置可能回数が設定される
- ミノを配置するたびに1減少する
- 0になると新しいミノを引けなくなる
- ラウンドクリア時の残り回数がゴールド報酬になる

### 自動補充

- 全てのスロットが空になると自動的に新しいミノセット（3個）を引く
- ただし残り配置回数が0の場合は補充されない

## ラウンドシステム

### ラウンド構成

- 全24ラウンド（`ROUND_CONFIG.maxRound`）
- 各ラウンドは独立したゲームプレイ
- ラウンド開始時にボード、スコア、配置回数がリセットされる

### 目標スコア

- 各ラウンドに目標スコアが設定される
- 目標スコアを達成するとラウンドクリア
- 目標スコアはラウンドが進むにつれて増加する

### ラウンドクリア条件

- 現在スコアが目標スコア以上に達する
- 達成時に自動的にround_clearフェーズに遷移

### ゲームオーバー条件

- 残り配置回数が0で目標スコア未達成の場合
- game_overフェーズに遷移

### ゲームクリア条件

- 最終ラウンド（24ラウンド）をクリア
- game_clearフェーズに遷移

## ゴールドシステム

### ゴールド獲得

- ラウンドクリア時に残り配置回数がゴールド報酬として付与される
- ゴールドはラウンド間で持ち越される

### ゴールドの用途

- ショップでミノを購入する際に消費される
- 購入価格はミノのセル数と同じ

## ショップシステム

### ショップフェーズ

- ラウンドクリア後にshoppingフェーズに移行（最終ラウンドを除く）
- ゴールド報酬が加算された状態でショップが開かれる

### ショップアイテム生成

3種類のミノがランダムに選ばれる:

1. **小サイズ**: モノミノ/ドミノ/トロミノから1つ
2. **中サイズ**: テトロミノ/ペントミノから1つ
3. **大サイズ**: ペントミノ/ヘキソミノから1つ

各カテゴリ群からランダムにミノが選択される。

### 価格設定

- 各ミノの価格はセル数と同じ
- モノミノ: 1ゴールド
- ドミノ: 2ゴールド
- トロミノ: 3ゴールド
- テトロミノ: 4ゴールド
- ペントミノ: 5ゴールド
- ヘキソミノ: 6ゴールド

### 購入処理

- 所持ゴールドが価格以上の場合のみ購入可能
- 購入するとゴールドが減少し、ミノがデッキに追加される
- 購入済みアイテムは再購入不可（購入済みフラグが立つ）

### ショップ退出

- 「ショップを出る」操作で次のラウンドに進む
- デッキがシャッフルされ、配置回数がリセットされる
- ボードとスコアがリセットされる

## ミノ形状システム

### ミノカテゴリ

ミノはセル数によって6つのカテゴリに分類される:

1. **モノミノ**: 1セル - 1種類
2. **ドミノ**: 2セル - 2種類（横・縦）
3. **トロミノ**: 3セル - 6種類
4. **テトロミノ**: 4セル - 19種類
5. **ペントミノ**: 5セル - 63種類
6. **ヘキソミノ**: 6セル - 216種類（35基本形 × 回転・反転）

**合計**: 307種類のミノ定義

### ミノ定義データ構造

- `MinoDefinition`: ミノの定義
  - `id`: ミノの識別子（例: `"hex-K20-m90"`）
  - `category`: カテゴリ（`'monomino'` ~ `'hexomino'`）
  - `shape`: 2次元配列の真偽値（`true` = ブロックあり）
  - `cellCount`: セル数

### ASCII形状定義

ミノ形状はASCIIアート形式で定義される:
- `#`: ブロックあり
- `.`: 空セル
- 各行の長さが異なる場合、最大幅に合わせて自動パディング

### ブロック生成

`Piece` オブジェクトは `MinoDefinition` から生成される:
- ユニークID: タイムスタンプ + 乱数で生成
- 形状: ミノ定義から継承

## ブロック配置

### 配置処理

- 指定位置にブロックを配置する（immutableパターン）
- 新しいボードオブジェクトを返す（元のボードは変更しない）
- ブロック形状の各セルが `true` の位置に対応するボードセルを `filled: true` に設定する

### 前提条件

配置処理を実行する前に、必ず衝突判定で配置可能かチェックする必要がある。

### 配置後の処理

1. スロットからブロックを削除
2. 残り配置回数を1減少
3. 全スロットが空かつ残り配置回数が0より大きい場合、新しいミノセットを引く
4. ライン完成を判定
5. スコアとフェーズを更新

## 衝突判定

### 配置可能性チェック

以下の条件をすべて満たす場合に配置可能と判定される:

1. **範囲内チェック**: ブロックのすべてのセルがボード範囲内に収まる
2. **重複チェック**: ブロックのセルと既に埋まっているセルが重複しない

### チェック処理

- ブロック形状の各セル（`true` のセル）に対して判定を実行
- 1つでも条件を満たさないセルがあれば配置不可と判定

### 座標変換

スクリーン座標（ピクセル単位）からボード座標（グリッド単位）への変換機能を提供:

- ドラッグ位置をボード上のグリッド位置に変換
- ボードオフセットとセルサイズを考慮した計算
- `Math.floor` で切り捨て処理

### ボード範囲チェック

- 指定座標がボード範囲内（0 ~ GRID_SIZE-1）かを判定する独立した関数

## ドラッグ&ドロップ

### ドラッグ開始

1. プレイヤーがブロックスロット上でマウス/タッチを開始
2. スロットインデックスと開始位置を記録
3. ドラッグ状態を有効化
4. playingフェーズでのみドラッグ可能

### ドラッグ中

1. マウス/タッチ位置を追跡
2. 現在位置をスクリーン座標からボード座標に変換
3. 変換されたボード座標で配置可能性をチェック
4. プレビュー表示を更新

### ドラッグ終了

1. ドロップ時のボード座標を取得
2. 配置可能かチェック
   - **配置可能**: ブロックをボードに配置し、スロットから削除
   - **配置不可**: 何も変更せずドラッグ状態をクリア
3. playingフェーズでない場合は配置不可

## プレビュー表示

### プレビュー判定

- ドラッグ中のみプレビューを表示
- ボード座標が取得できている場合のみ表示
- 配置可能性に応じて色を変更

### プレビュー色

- **配置可能**: 半透明の茶色系（`previewValid`）
- **配置不可**: 半透明の赤色（`previewInvalid`）

### 描画範囲

- プレビューはボード範囲内のセルのみ描画
- ブロック形状の各 `true` セルに対応する位置に描画

## ライン消去システム

### ライン完成判定

- **行**: すべてのセルが埋まっている行を検出
- **列**: すべてのセルが埋まっている列を検出
- 複数ラインの同時検出が可能

### 消去対象セル決定

- 完成した行と列のセルを収集
- 重複するセル（行と列が交差する位置）は1回のみカウント
- `Set` を使用して重複を除去

### スコア計算

スコア = 消去されたセル数 × 消去されたライン数

例:
- 1行のみ消去（6セル） × 1ライン = 6点
- 1行 + 1列（11セル、交差1セル） × 2ライン = 22点

### スコアとフェーズ判定

- ライン消去後、スコアが目標スコア以上ならround_clearフェーズに遷移
- 残り配置回数が0かつ目標未達成ならgame_overフェーズに遷移

### ライン消去実行

- 消去対象セルを `filled: false` に設定
- 新しいボードオブジェクトを返す（immutable）

## 消去アニメーション

### アニメーション効果

- 回転: 0度から180度まで
- 上昇: セルが上方向に移動
- 縮小: スケールが1.0から0.0に変化
- イージング: ease-out cubic

### アニメーション状態

- `isAnimating`: アニメーション中フラグ
- `cells`: 消去対象セル配列
- `startTime`: 開始時刻（タイムスタンプ）
- `duration`: 継続時間

### 描画タイミング

- アニメーション中は `requestAnimationFrame` でループ
- 進行度に応じてセルを変形・描画
- 完了時に `END_CLEAR_ANIMATION` アクションで実際の消去を実行

## 乱数生成器

2種類の乱数生成器を提供:
- `DefaultRandom`: `Math.random()` のラッパー（本番環境用）
- `SeededRandom`: シード対応（テスト用、Mulberry32アルゴリズム）

用途:
- デッキのシャッフル
- ショップアイテムの選択
- ミノの選択（デッキベースに移行したため直接的な使用は減少）

## 関連ファイル

- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/boardLogic.ts` - ボード管理ロジック
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/collisionDetection.ts` - 衝突判定
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/minoDefinitions.ts` - ミノ定義
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/deckLogic.ts` - デッキ管理
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/roundLogic.ts` - ラウンド・ゴールド計算
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/shopLogic.ts` - ショップロジック
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/lineLogic.ts` - ライン消去とスコア計算
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/random.ts` - 乱数生成器
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/components/renderer/previewRenderer.ts` - プレビュー描画
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/components/renderer/clearAnimationRenderer.ts` - 消去アニメーション描画

## 更新履歴

- 2026-02-01: 初版作成
- 2026-02-01: ミノシステム、生成ロジック、ライン消去、アニメーションを追加
- 2026-02-02: デッキシステム、ラウンド制、ゴールド、ショップ、フェーズ判定を追加
