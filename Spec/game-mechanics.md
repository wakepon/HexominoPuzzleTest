# ゲームメカニクス

## 概要

ブロック配置パズルのコアメカニクス（ボード管理、ブロック配置、衝突判定、デッキシステム、ラウンド制、ショップ、エフェクトシステム）について説明する。

## ボード管理

### ボード構造

- 6x6のグリッド（`GRID_SIZE = 6`）
- 各セルは `Cell` 型で表現される
  - `filled: boolean` - セルが埋まっているかどうか
  - `blockSetId: BlockSetId | null` - 配置されたブロックセットのID
  - `pattern: PatternId | null` - パターン効果（enhanced, lucky, feather, nohand, charge, obstacle）
  - `seal: SealId | null` - シール効果（gold, multi, stone）
  - `chargeValue: number` - chargeパターン用の蓄積値
  - `buff: BuffType | null` - セルに刻まれた永続バフ（enhancement, gold_mine, pulsation, phase）
  - `buffLevel: number` - バフのレベル（0以上）
  - `blockBlessing: BlessingId | null` - ブロック配置時の加護情報（消去時にバフとしてスタンプされる）

### 空ボード生成

- ゲーム開始時とラウンド開始時に全セルが空の状態でボードが生成される
- すべてのセルの `filled` が `false`、その他のフィールドが初期値で初期化される

### バフの永続化

- バフは消去後もセルに残る（`clearLines` で `buff` と `buffLevel` は維持される）
- ラウンド遷移時は `preserveBuffsOnBoard` でバフを引き継ぐ

## デッキシステム

### デッキの構成

- デッキは複数のミノIDから構成される
- 初期デッキは6枚: `mono-1, dom-h, dom-v, tro-i-h, tro-i-v, tro-l-0`
- ショップで購入したミノがデッキに追加される
- 6枚 / 12ハンド = 2周回転。護符で強化したピースを確実に2回使える
- ピース追加でデッキが7-8枚になっても1.5周以上回る
- 追加しすぎるとデッキ回転率が落ちる → 「追加 vs 圧縮」の判断が戦略になる

### デッキの初期化

- ゲーム開始時に初期デッキミノIDリストが取得される
- Fisher-Yatesアルゴリズムでシャッフルされる
- 配置可能回数が初期値に設定される

### ミノの引き出し

- デッキから指定枚数（通常3枚）のミノIDを引く
- デッキが足りない場合は残りを全て引いた後、初期ミノIDリストを再シャッフルして補充
- 引いたミノIDからPieceオブジェクトを生成

### ミノID→Piece変換

- ミノIDから対応するMinoDefinitionを取得
- タイムスタンプと乱数でユニークなPiece IDを生成
- MinoDefinitionの形状を継承してPieceを作成
- 購入済みPieceがある場合はそのパターン・シール・加護情報を使用

### 残り配置回数

- ラウンド開始時に配置可能回数が設定される（通常12回）
- ミノを配置するたびに1減少する
- 0になると新しいミノを引けなくなる
- ラウンドクリア時の残り回数がゴールド報酬に影響する

### 自動補充

- 全てのスロットが空になると自動的に新しいミノセット（3個）を引く
- ただし残り配置回数が0の場合は補充されない

## ラウンドシステム

### ラウンド構成

- 全24ラウンド（`ROUND_CONFIG.maxRound`）
- 各ラウンドは独立したゲームプレイ
- ラウンド開始時にボード、スコア、配置回数がリセットされる

### ラウンドセット

3ラウンドで1セットを構成:

| ラウンド位置 | タイプ | ラベル | クリア報酬 |
|--------------|--------|--------|------------|
| 1番目 | normal | 雑魚 | 低 |
| 2番目 | elite | エリート | 中 |
| 3番目 | boss | ボス | 高 |

**セット番号計算:**
```
setNumber = Math.floor((round - 1) / 3) + 1
positionInSet = (round - 1) % 3  // 0, 1, 2
roundType = TYPES[positionInSet]  // normal, elite, boss
```

### ボス特殊条件

ボスラウンドでは以下のいずれかの条件がランダムに適用される:

| ID | 名前 | 効果 |
|----|------|------|
| `obstacle` | おじゃまブロック | ランダムな4マスが埋まっている（消去不可） |
| `energy_save` | 省エネ | 配置可能数が75%に減少 |
| `two_cards` | 手札2枚 | 手札が2枚になる（通常3枚） |

**条件の適用:**
```
// 最大配置数
getMaxPlacements() {
    if (isBoss && bossCondition.id === 'energy_save') {
        return 通常の配置数 × 0.75
    }
    return 通常の配置数
}

// ドロー枚数
getDrawCount() {
    if (isBoss && bossCondition.id === 'two_cards') {
        return 2
    }
    return 3
}
```

**おじゃまブロックの配置:**
- ラウンド開始時にランダムな位置に4マス配置
- セルは `pattern: 'obstacle'` としてマーク（ネガティブパターン）
- ライン消去で消えない

**条件の抽選タイミング:**
- 新しいセットに入る時に抽選
- 同じセット内では条件は固定

### 目標スコア

- 各ラウンドに目標スコアが設定される
- 目標スコアを達成するとラウンドクリア
- 目標スコアはラウンドが進むにつれて増加する（初期値と増加量はパラメータ）

### ラウンドクリア条件

- 現在スコアが目標スコア以上に達する
- 達成時に自動的にround_clearフェーズに遷移

### ラウンドクリア時の処理

1. クリアメッセージを表示
2. ラウンドタイプに応じた報酬を付与
3. ショップ画面を表示（最終ラウンド以外）

### ゲームオーバー条件

- 残り配置回数が0で目標スコア未達成の場合
- 手札のすべてのブロックがどこにも配置できない場合
- game_overフェーズに遷移

### ゲームオーバー時の処理

1. ゲームオーバー画面を表示
2. ハイスコア（最高到達ラウンド）を保存
3. ゴールドを0にリセット
4. レリックをリセット

### ゲームクリア条件

- 最終ラウンド（24ラウンド）をクリア
- game_clearフェーズに遷移

### 次ラウンド開始処理

```
startNextRound() {
    round++
    resetScore()
    clearBoard()

    // ボス条件: おじゃまブロック
    if (isBoss && bossCondition.id === 'obstacle') {
        placeObstacleBlocks()  // 4マスをランダム配置
    }

    resetDeck()
    blocksPlacedCount = 0
    currentBlocks = draw(getDrawCount())

    updateUI()
    checkGameOver()
}
```

## ゴールドシステム

### ゴールド報酬計算

ラウンドクリア時の報酬:

```
goldReward = BASE_REWARD[roundType] + remainingHands
```

- ベース報酬はラウンドタイプごとに異なる
  - normal: 1
  - elite: 2
  - boss: 5
- 残りハンド数（残り配置回数）がそのまま加算される

### 利息（未実装）

ラウンドクリア時に所持ゴールドに応じた利息を獲得する予定。

| 所持ゴールド | 利息 |
|---|---|
| 0〜4G | +0G |
| 5〜9G | +1G |
| 10〜14G | +2G |
| 15〜19G | +3G |
| 20〜24G | +4G |
| 25G以上 | +5G（上限） |

### ゴールドの用途

- ショップでミノ・レリック・護符を購入する際に消費される
- ミノの購入価格はセル数に基づく
- レリックの売却で購入価格の半額を回収できる（未実装）

## ショップシステム

### ショップフェーズ

- ラウンドクリア後にshoppingフェーズに移行（最終ラウンドを除く）
- ゴールド報酬が加算された状態でショップが開かれる

### 商品構成

| 枠 | 内容 | 枠数 |
|---|---|---|
| ピース枠 | 小〜中サイズ / 中〜大サイズ | 2 |
| レリック/護符枠 | レリックと護符がランダムに混在 | 3 |
| **合計** | | **5** |

### 商品カテゴリ

- **ブロックセット**: 通常ブロック、パターン付き、シール付き、加護付き
- **レリック**: 恒久的なパッシブ効果アイテム（所持上限5枠）
- **護符**: デッキの質を変える消費アイテム（ストック上限2個、未実装）

### ブロックセット商品

#### 通常ブロック

2種類のミノがランダムに選ばれる:

1. **小〜中サイズ**: モノミノ/ドミノ/トロミノ/テトロミノから1つ
2. **中〜大サイズ**: テトロミノ/ペントミノ/ヘキソミノから1つ

価格はセル数に基づいて設定（セル数=価格）。

#### パターン付きブロックセット

ブロック全体に特殊効果が付与される。詳細は[パターンシステム](#パターンシステム)を参照。

付与確率: 40%（ミノサイズに関わらず一律）

#### シール付きブロックセット

特定のセルに特殊効果が付与される。詳細は[シールシステム](#シールシステム)を参照。

付与確率: 25%（ミノサイズに関わらず一律）

#### 加護付きブロックセット

特定のセルに加護が付与される。詳細は[加護システム](#加護バフシステム)を参照。

付与確率: 15%（ミノサイズに関わらず一律）

### レリック商品

- レリック/護符3枠にランダムに出現（レアリティに基づく重み付き抽選）
- 未所持のレリックからランダムに選択
- レリック5枠が埋まっていても表示される（売却→購入の導線、未実装）
- すべてのレリックを所持している場合はレリックの代わりに護符が出現（未実装）
- 詳細は[レリックシステム](#レリックシステム)を参照

### 護符商品（未実装）

- レリック/護符3枠にランダムに混在して出現予定（30%の確率でレリック枠の1つを護符に置換）
- 購入後はストック（最大2個）に保管される
- 使用タイミング: ショップフェーズ中、またはパズル中

### セール表示

- 全商品からランダムに1つが25%OFFで販売される

### 購入処理

#### ブロックセット購入

1. ゴールドを消費
2. 商品を売却済みにマーク
3. デッキにブロックを追加（パターン・シール・加護情報付き）
4. UI更新

#### レリック購入

1. ゴールドを消費
2. 商品を売却済みにマーク
3. レリックを所持リストに追加
4. UI更新

#### レリック売却（未実装）

1. ショップフェーズ中に所持レリックを選択
2. 売却確認
3. 購入価格の半額（端数切り捨て）のゴールドを獲得
4. レリックを所持リストから除去
5. UI更新

#### 購入条件

- 所持ゴールドが価格以上
- 商品が未購入

### ショップリロール

- リロールボタンでショップの全商品を再生成できる
- リロールコストは初期値から徐々に増加する
- merchantレリック所持時は割引される

### ショップ退出

- 「次へ」または「ショップを出る」ボタンで次のラウンドに進む
- 購入は必須ではない（何も買わずに進行可能）
- デッキがシャッフルされ、配置回数がリセットされる
- ボードとスコアがリセットされる
- ラウンド進行画面を表示

## ミノ形状システム

### ミノカテゴリ

ミノはセル数によって6つのカテゴリに分類される:

1. **モノミノ**: 1セル - 1種類
2. **ドミノ**: 2セル - 2種類（横・縦）
3. **トロミノ**: 3セル - 6種類
4. **テトロミノ**: 4セル - 19種類
5. **ペントミノ**: 5セル - 63種類
6. **ヘキソミノ**: 6セル - 216種類（35基本形 × 回転・反転）

**合計**: 307種類のミノ定義

### ミノ定義データ構造

- `MinoDefinition`: ミノの定義
  - `id`: ミノの識別子（例: `"hex-K20-m90"`）
  - `category`: カテゴリ（`'monomino'` ~ `'hexomino'`）
  - `shape`: 2次元配列の真偽値（`true` = ブロックあり）
  - `cellCount`: セル数

### ASCII形状定義

ミノ形状はASCIIアート形式で定義される:
- `#`: ブロックあり
- `.`: 空セル
- 各行の長さが異なる場合、最大幅に合わせて自動パディング

### ブロック生成

`Piece` オブジェクトは `MinoDefinition` から生成される:
- ユニークID: タイムスタンプ + 乱数で生成
- 形状: ミノ定義から継承
- BlockDataMap: 形状から自動生成（パターン・シール・加護付与時は対応する値を設定）

## ブロック配置

### 配置処理

- 指定位置にブロックを配置する（immutableパターン）
- 新しいボードオブジェクトを返す（元のボードは変更しない）
- ブロック形状の各セルが `true` の位置に対応するボードセルを `filled: true` に設定する
- BlockDataから取得したパターン・シール情報をセルに反映する
- 加護情報は `blockBlessing` として一時保持される（消去時にバフとしてスタンプされる）
- 既存のバフは維持される（ブロック配置でバフは消えない）

### 前提条件

配置処理を実行する前に、必ず衝突判定で配置可能かチェックする必要がある。

### 配置後の処理

1. スロットからブロックを削除
2. 残り配置回数を1減少
3. 全スロットが空かつ残り配置回数が0より大きい場合、新しいミノセットを引く
4. chargeパターンブロックのchargeValueを加算
5. ライン完成を判定
6. スコアとフェーズを更新

## 衝突判定

### 配置可能性チェック

以下の条件をすべて満たす場合に配置可能と判定される:

1. **範囲内チェック**: ブロックのすべてのセルがボード範囲内に収まる
2. **重複チェック**: ブロックのセルと既に埋まっているセルが重複しない
   - **例外**: featherパターンの場合、既存ブロックがfeatherでなければ重ね置き可能

### チェック処理

- ブロック形状の各セル（`true` のセル）に対して判定を実行
- 1つでも条件を満たさないセルがあれば配置不可と判定

### 座標変換

スクリーン座標（ピクセル単位）からボード座標（グリッド単位）への変換機能を提供:

- ドラッグ位置をボード上のグリッド位置に変換
- ボードオフセットとセルサイズを考慮した計算
- `Math.floor` で切り捨て処理

### ボード範囲チェック

- 指定座標がボード範囲内（0 ~ GRID_SIZE-1）かを判定する独立した関数

## ドラッグ&ドロップ

### ドラッグ開始

1. プレイヤーがブロックスロット上でマウス/タッチを開始
2. スロットインデックスと開始位置を記録
3. ドラッグ状態を有効化
4. playingフェーズでのみドラッグ可能

### ドラッグ中

1. マウス/タッチ位置を追跡
2. 現在位置をスクリーン座標からボード座標に変換
3. 変換されたボード座標で配置可能性をチェック
4. プレビュー表示を更新

### ドラッグ終了

1. ドロップ時のボード座標を取得
2. 配置可能かチェック
   - **配置可能**: ブロックをボードに配置し、スロットから削除
   - **配置不可**: 何も変更せずドラッグ状態をクリア
3. playingフェーズでない場合は配置不可

## プレビュー表示

### プレビュー判定

- ドラッグ中のみプレビューを表示
- ボード座標が取得できている場合のみ表示
- 配置可能性に応じて色を変更

### プレビュー色

- **配置可能**: 半透明の茶色系（`previewValid`）
- **配置不可**: 半透明の赤色（`previewInvalid`）

### 描画範囲

- プレビューはボード範囲内のセルのみ描画
- ブロック形状の各 `true` セルに対応する位置に描画

## パターンシステム

### パターンの種類

ブロック全体に適用される効果:

| パターンID | 名前 | 効果 | 記号 |
|-----------|------|------|------|
| `enhanced` | 強化ブロック | ブロック点+2 | ★ |
| `lucky` | ラッキーブロック | このブロックが消えると確率で列点x2 | ♣ |
| `feather` | 羽ブロック | 既にブロックがある場所に重ねて配置できる | F |
| `nohand` | ノーハンドブロック | 配置してもハンドを消費しない | N |
| `charge` | チャージブロック | 他のブロックが置かれるたび、ブロック点が累積する | ⚡ |
| `obstacle` | おじゃまブロック | 消去できないブロック（ボス条件） | × |

### パターンの付与

- ショップで購入時にランダムに付与される
- 付与確率は一律
- ショップで購入可能なパターン: enhanced, lucky, feather, nohand, charge

### パターンとスコア計算

詳細は[スコア計算](#スコア計算)を参照。

## シールシステム

### シールの種類

特定のセルに適用される効果:

| シールID | 名前 | 効果 | 記号 |
|---------|------|------|------|
| `gold` | ゴールドシール | このブロックが消えると+1G | G |
| `multi` | マルチシール | このブロックは2回発動する | ×2 |
| `stone` | 石 | このブロックは消えない | 石 |

### シールの付与

- ショップで購入時にランダムに付与される
- 付与確率は一律
- 付与位置はランダム
- ショップで購入可能なシール: gold, multi

### シールとスコア計算

詳細は[スコア計算](#スコア計算)を参照。

### 石シールの特性

- 石シール付きセルはライン完成の判定を阻害する
- 石シール付きセルが含まれる行・列は完成とみなされない

## 加護・バフシステム

### 概念の分離

- **加護（Blessing）**: ピース上の効果。消去時にセルにバフとしてスタンプされる
- **バフ（Buff）**: セルに刻まれた永続効果。ラウンドをまたいで維持される

### 加護の種類

| 加護ID | 名前 | 効果 | 記号 | 最大レベル |
|-------|------|------|------|-----------|
| `power` | 力の加護 | 消滅時にセルに増強を付与する | 力 | 3 |
| `gold` | 金の加護 | 消滅時にセルに金鉱を付与する | 金 | 3 |
| `chain` | 連の加護 | 消滅時にセルに脈動を付与する | 連 | 3 |
| `phase` | 透の加護 | 消滅時に確率でセルに透過を付与する | 透 | 1 |

### バフの種類

| バフID | 名前 | 効果 |
|-------|------|------|
| `enhancement` | 増強 | ライン消去時にブロック点を加算する |
| `gold_mine` | 金鉱 | ライン消去時に確率でゴールドを獲得する |
| `pulsation` | 脈動 | ライン消去時に列点を加算する |
| `phase` | 透過 | ブロックをその上に配置可能にする（featherと同じ） |

### バフの付与

- ブロック配置時に `blockBlessing` として一時保持される
- ライン消去時に対象セルの加護がバフとしてスタンプされる
- 加護によってバフの種類と付与条件が異なる
- 透の加護のみ確率付与

### バフのレベル

- バフは累積してレベルが上昇する
- 効果値はレベルに比例する
- 最大レベルは加護の `maxLevel` で定義される

### バフの永続性

- バフは消去後もセルに残る
- ラウンド遷移時もバフは引き継がれる

## レリックシステム

### レリック数と種類

全52種類のレリックが存在する:

- **サイズボーナス系** (6種): 1〜6サイズボーナス
- **乗算系** (17種): 連鎖の達人、シングルライン、タケノコ、カニ、のびのびタケノコ、のびのびカニ、連射、全消しボーナス、タイミング、流星、シンメトリー、三日月、ラストスタンド、先制攻撃、忍耐、過負荷、オーケストラ
- **加算系** (18種): アンカー、王冠、スタンプ、コンパス、軽量級、重量級、十字、雪だるま、筋肉、庭師、双子、ミニマリスト、錬金術師、溶鉱炉
- **台本系** (1種): 台本
- **ユーティリティ系** (10種): 手札ストック、火山、絆創膏、コピー、商人、トレジャーハンター、ミダス、追加ドロー、追加ハンド、リサイクラー、金魚、不死鳥、道化師
- **効果強化系** (4種): アンプリファイア、プリズム、磁石、ギャンブラー

### レリックのレアリティ

レアリティに基づく重み付き抽選:

- **common**: 出現重み70
- **uncommon**: 出現重み25
- **rare**: 出現重み5
- **epic**: 出現重み0.3

### レリック効果の種類

レリック効果は3種類に分類される:

1. **加算系（additive）**: ブロック点(A)に加算
2. **ライン加算系（line_additive）**: 列点(B)にライン数を加算
3. **乗算系（multiplicative）**: 列点(B)に乗算

### レリック効果の適用順序

レリック効果は `relicDisplayOrder`（所持レリックの表示順）に従って適用される。

詳細は[スコア計算](#スコア計算)を参照。

### コピーレリック

- 1つ上のレリック（表示順）の効果をコピーする
- コピー対象が加算系の場合、同じ値をブロック点に加算
- コピー対象がライン加算系の場合、同じ値を列点に加算
- コピー対象が乗算系の場合、同じ倍率を列点に乗算
- コピー効果は対象レリックの直後に適用される

### 特殊レリック

- **手札ストック**: ストック枠が出現し、ブロックを1つ保管可能
- **火山**: ラウンド中にブロックが消えなかった場合、ハンド0で全消去
- **絆創膏**: ハンド消費ごとにノーハンド付きモノミノが手札に追加
- **台本**: ラウンド開始時に指定ラインが2本出現。揃えた際の列数を加算
- **追加ドロー**: ドロー枚数が+1
- **追加ハンド**: ラウンド中のハンド数が+2
- **リサイクラー**: ラウンド中に手札1枚を入替可能
- **不死鳥**: ラウンド失敗時、1度だけラウンドをやり直せる（使用後消滅）
- **商人**: ショップのリロール費用を割引
- **道化師**: レリック枠が1枠減少する代わりに、ショップで全商品が割引される
- **トレジャーハンター**: ゴールドシール（G）付きブロック消去時、追加でゴールドを獲得
- **ミダス**: 全消し時にゴールドを獲得
- **金魚**: ラウンドクリア時にスコアが目標の一定倍以上でゴールドを獲得
- **磁石**: chargeパターン（⚡）の蓄積速度を倍化
- **アンプリファイア**: enhancedパターン（★）のブロック点ボーナスを強化
- **プリズム**: multiシール（×2）の効果を強化
- **溶鉱炉**: stoneシール付きブロック消去時、ブロック点を加算

### レリックの所持上限

- 所持上限は5枠（`MAX_RELIC_SLOTS = 5`）
- 道化師レリック所持時は4枠に減少

### レリックの売却（未実装）

- 購入価格の半額（端数切り捨て）で売却可能
- ショップフェーズ中に実行可能

## ライン消去システム

### ライン完成判定

- **行**: すべてのセルが埋まっている行を検出
- **列**: すべてのセルが埋まっている列を検出
- 複数ラインの同時検出が可能

### 消去対象外

以下のセルはライン消去から除外される:

- **石シール付きセル**: `seal === 'stone'`（`preventsClearing` フラグ）
- **ネガティブパターンのセル**: `pattern === 'obstacle'` 等（`isNegative` フラグ）

これらのセルが含まれている行・列は完成とみなされない。

### 消去対象セル決定

- 完成した行と列のセルを収集
- 重複するセル（行と列が交差する位置）は1回のみカウント
- `Set` を使用して重複を除去
- その後、石シール・ネガティブパターンのセルをフィルタリング

### 消去実行

- 消去対象セルを `filled: false` に設定
- パターン・シール・chargeValue・blockBlessingをクリア
- バフ・buffLevelは維持される（消去後もセルに残る）
- 新しいボードオブジェクトを返す（immutable）

### 加護のバフ化

- 消去時に `blockBlessing` がバフとしてセルにスタンプされる
- 詳細は加護エフェクトハンドラを参照

## スコア計算

### 用語定義

| 用語 | 変数名 | 説明 |
|------|--------|------|
| **ブロック点 (A)** | `blockPoints` | 消去ブロック数にパターン・シール効果と加算レリック・バフを加えた値 |
| **列点 (B)** | `linePoints` | 消去ライン数にluckyを乗算し、脈動バフ・台本加算を加え、乗算レリックを適用した値 |
| **列倍率** | — | 列点(B)に対して適用される各種乗算レリック効果の総称 |

### 計算式（A×B方式）

最終スコアはブロック点(A)と列点(B)の積で決定される:

```
最終スコア = Math.floor( ブロック点(A) × 列点(B) )
```

### 計算フロー概要

```
1. 消去対象セルを収集（石シール・ネガティブパターン除外）
2. パターン効果を計算（enhanced, charge）
3. シール効果を計算（multi, gold）
4. バフ効果を計算（enhancement, pulsation, gold_mine）
5. ブロック点(A) = totalBlocks + 増強バフ + 加算レリック
6. 列点(B) = linesCleared × luckyMultiplier + 脈動バフ + 台本加算
7. 列点(B)に乗算レリックを順次適用
8. 最終スコア = Math.floor(A × B)
```

### totalBlocks（基礎ブロック数）の計算

```
totalBlocks =
  baseBlocks            // 消去対象セル数
  - chargeBlockCount    // chargeブロックの基礎分を除外
  + enhancedBonus       // enhanced効果（+2/個、amplifier所持で+5/個、multi付きで2倍）
  + chargeBonus         // charge蓄積値合計（multi付きで2倍）
  + multiBonus          // multiシール効果（+1/個、prism所持で+2/個）
```

### パターン効果

#### ブロック点(A)に影響するパターン

| パターンID | 効果 | amplifier所持 | multi付き |
|-----------|------|--------------|-----------|
| `enhanced` | ブロック点+2/個 | +5/個 | パターン効果2倍（prism所持で3倍） |
| `charge` | 基礎ブロック数から除外され、chargeValue合計をブロック点に加算 | — | パターン効果2倍（prism所持で3倍） |

#### 列点(B)に影響するパターン

| パターンID | 効果 | multi付き |
|-----------|------|-----------|
| `lucky` | 確率で列点の起点値が2倍（luckyMultiplier=2） | 2回抽選（prism所持で3回） |

#### スコアに影響しないパターン

| パターンID | 効果 |
|-----------|------|
| `nohand` | 配置時にハンドを消費しない |
| `feather` | 既存ブロックの上に重ね置き可能 |
| `obstacle` | ネガティブパターン。消去不可 |

### シール効果

| シールID | 影響先 | 効果 | prism所持 |
|---------|--------|------|----------|
| `multi` | ブロック点(A) | ブロック点を加算（+1/個）。パターン効果を2倍化 | 3倍化 |
| `gold` | — | ゴールド+1/個（スコアに影響しない） | — |
| `stone` | — | 消去対象から除外（ライン完成を阻害） | — |

### バフ効果

| バフID | 影響先 | 効果 |
|-------|--------|------|
| `enhancement` | ブロック点(A) | ブロック点を加算（レベルに比例） |
| `pulsation` | 列点(B) | 列点を加算（レベルに比例） |
| `gold_mine` | — | ゴールドを獲得（確率、レベルに比例） |
| `phase` | — | ブロックをその上に配置可能にする |

### luckyパターン

- 消去対象に `lucky` パターンのセルが含まれる場合、確率で当選
- 当選時: luckyMultiplier=2（列点(B)の起点計算で `linesCleared × 2` になる）
- 外れ: luckyMultiplier=1（通常通り）
- multiシール付きluckyブロックは複数回抽選（どれか1回でも当たれば2倍）

### ブロック点(A)の詳細計算

```
blockPoints = totalBlocks + 増強バフ

// relicDisplayOrder順に加算レリックを適用:
//   + sizeBonusTotal（サイズボーナス発動時: baseBlocks）
//   + その他加算レリック（発動条件を満たした場合）
//   + copyBonus（コピーが加算系対象の場合、対象直後）
```

### 列点(B)の詳細計算

```
linePoints = linesCleared × luckyMultiplier + 脈動バフ

// relicDisplayOrder順に台本加算・乗算レリックを適用:
//   + scriptLineBonus（台本: 1本→+1、2本→+2）
//   + copyLineBonus（コピーが台本対象の場合）
//   × 各乗算レリック倍率（切り捨てなし）
//   × copyMultiplier（コピーが乗算系対象の場合、対象直後）
```

### 列倍率（乗算レリック → 列点(B)に乗算）

乗算レリックは列点(B)に対して `relicDisplayOrder`（所持レリックの表示順）に従って順番に適用される。各ステップでは切り捨てなしで乗算される。

主な乗算レリック:

- **連鎖の達人**: 2ライン以上同時消去で列点×1.5
- **シングルライン**: 1ラインのみ消去で列点×3
- **タケノコ**: 縦列のみ消去で列点×消去列数
- **カニ**: 横行のみ消去で列点×消去行数
- **のびのびタケノコ**: 縦列のみ消去で列点に累積倍率を乗算（横行消しでリセット）
- **のびのびカニ**: 横行のみ消去で列点に累積倍率を乗算（縦列消しでリセット）
- **連射**: ライン消去時に列点に累積倍率を乗算（消去なしでリセット）
- **タイミング**: 残りハンド数が3で割り切れる、かつライン消去ありで列点×3
- **全消しボーナス**: 盤面を全て空にした場合、列点×5
- **流星**: 3ライン以上同時消しで列点×2
- **シンメトリー**: 消去した行数と列数が同数の時、列点×2
- **三日月**: 残りハンド数が奇数の時、列点×1.5
- **ラストスタンド**: 残りハンド数が一定以下の時、列点を倍化
- **先制攻撃**: ラウンド中の最初のライン消去で列点を倍化
- **忍耐**: 連続消去なしの後の次の消去で列点を倍化
- **過負荷**: 盤面の一定割合以上が埋まっている状態でライン消去すると列点×2
- **オーケストラ**: 1回の消去で異なるパターンが一定種類以上含まれると列点×2
- **コピー**: 1つ上のレリックが乗算系の場合、対象と同じ倍率をコピーして乗算

**コピーレリックの乗算タイミング:** コピー対象レリックの直後に乗算が適用される（`relicDisplayOrder` 順）。

### レリック効果（加算系 → ブロック点(A)に加算）

relicDisplayOrder順にブロック点(A)に加算される:

主な加算レリック:

- **サイズボーナス**: 対応サイズのピースでライン消去時、消去ブロック数（baseBlocks）をブロック点に加算
- **アンカー**: ラウンド中の最初のライン消去時、ブロック点を加算
- **王冠**: ライン消去時、消去セルのパターン付きブロックごとにブロック点を加算
- **スタンプ**: ライン消去時、消去セルのシール付きブロックごとにブロック点を加算
- **コンパス**: 行と列を同時に消した時、ブロック点を加算
- **軽量級**: 小サイズのピース配置でライン消去時、ブロック点を加算
- **重量級**: 大サイズのピース配置でライン消去時、ブロック点を加算
- **十字**: 行と列を同時に消した時、交差セルのブロック点を加算
- **雪だるま**: ライン消去ごとにブロック点を累積加算（ラウンドをまたいで永続）
- **筋肉**: 一定サイズ以上のピースを配置するたびに列点を累積加算（ラウンド中）
- **庭師**: パターン付きブロックを消すたびにブロック点を累積加算（ラウンド中）
- **双子**: 同サイズのピースを連続配置してライン消去時、ブロック点を加算
- **ミニマリスト**: デッキ枚数が一定以下の時、全ブロック点を加算
- **錬金術師**: パターンとシール両方持ちのブロック消去時、1個につきブロック点を加算
- **溶鉱炉**: stoneシール付きブロック消去時、1個につきブロック点を加算
- **コピー**: コピー対象が加算レリックの場合、対象と同じ加算量をコピーして加算

### レリック効果（ライン数加算系）

台本レリックはライン数を加算する（基本スコア計算に影響）:

- **台本**: ラウンド開始時指定の2本のラインを揃えた場合、1本揃いでライン数を+1、2本同時揃いでライン数を+2
- **コピー**: コピー対象が台本レリックの場合、対象レリックと同じライン数加算をコピーして加算

### 最終スコアの計算

```
finalScore = Math.floor( blockPoints × linePoints )
```

- ブロック点(A)と列点(B)の積を切り捨てたものが最終スコア
- 各乗算レリックは列点(B)に対して切り捨てなしで順次適用される
- 最後の `Math.floor` のみで切り捨てが行われる

### スコア演出

1. 画面中央に計算式表示
2. パターンボーナスがあれば段階的に表示
3. レリック効果があれば倍率・ボーナス表示
4. スコアカウンターのアニメーション
5. 消去されるブロック上にポップアップ表示

### スコアとフェーズ判定

- ライン消去後、スコアが目標スコア以上ならround_clearフェーズに遷移
- 残り配置回数が0かつ目標未達成ならgame_overフェーズに遷移

## 消去アニメーション

### アニメーション効果

- 回転: 0度から180度まで
- 上昇: セルが上方向に移動
- 縮小: スケールが1.0から0.0に変化
- イージング: ease-out cubic

### アニメーション状態

- `isAnimating`: アニメーション中フラグ
- `cells`: 消去対象セル配列
- `startTime`: 開始時刻（タイムスタンプ）
- `duration`: 継続時間

### 描画タイミング

- アニメーション中は `requestAnimationFrame` でループ
- 進行度に応じてセルを変形・描画
- 完了時に `END_CLEAR_ANIMATION` アクションで実際の消去を実行

## 配置不可検出

### 検出タイミング

- ブロック配置後
- 新しい手札をドロー後

### 処理フロー

1. すべての手札ブロックについて、ボード上のすべての位置で配置可否判定
2. 1つも配置できない場合、ダイアログ表示
3. 配置不可能なブロックをすべて「配置済み」扱い（配置カウント増加）
4. 配置カウントが上限に達していればラウンド終了処理
5. そうでなければ次のブロックをドロー
6. 再度チェック

### ダイアログ表示

- 配置不可能であることを通知
- 一定時間後にコールバック実行

## 乱数生成器

2種類の乱数生成器を提供:
- `DefaultRandom`: `Math.random()` のラッパー（本番環境用）
- `SeededRandom`: シード対応（テスト用、Mulberry32アルゴリズム）

用途:
- デッキのシャッフル
- ショップアイテムの選択
- ボス条件の抽選
- luckyパターンの判定
- バフ付与の判定

## 関連ファイル

- `src/lib/game/Services/LineService.ts` - ライン消去ロジック
- `src/lib/game/Services/RoundService.ts` - ラウンド管理・ゴールド計算
- `src/lib/game/Services/BoardService.ts` - ボード操作
- `src/lib/game/Services/ShopService.ts` - ショップ
- `src/lib/game/Services/DeckService.ts` - デッキ操作
- `src/lib/game/Services/CollisionService.ts` - 衝突判定
- `src/lib/game/Services/PieceService.ts` - ピース生成
- `src/lib/game/Data/Constants.ts` - ゲーム定数
- `src/lib/game/Data/BossConditions.ts` - ボス条件マスターデータ
- `src/lib/game/Domain/Effect/RelicEffectHandler.ts` - レリック効果計算
- `src/lib/game/Domain/Effect/Relic.ts` - レリック定義（52種）
- `src/lib/game/Domain/Effect/PatternEffectHandler.ts` - パターン効果計算・スコア計算統合
- `src/lib/game/Domain/Effect/SealEffectHandler.ts` - シール効果計算
- `src/lib/game/Domain/Effect/Pattern.ts` - パターン定義（6種）
- `src/lib/game/Domain/Effect/Seal.ts` - シール定義（3種）
- `src/lib/game/Domain/Effect/Blessing.ts` - 加護定義（4種）
- `src/lib/game/Domain/Effect/BlessingEffectHandler.ts` - 加護効果計算・バフスタンプ

## 更新履歴

- 2026-02-20: レリック52種に拡充、パターン/シールの一部削除（combo, aura, moss, score, arrow_v, arrow_h）、加護/バフシステム追加、スコア計算を最新実装に更新、レリック効果の種類を明記、ショップシステムの変更（2+3構成、加護商品追加、セール表示）、ボス条件・ラウンド報酬の数値を明記、chargeパターンのchargeValue加算を追加
- 2026-02-19: マルチシールのパターン効果2倍化を詳細に説明。タイミングレリック発動条件を「残りハンド数が3で割り切れる」に修正。のびのび系・連射の初期値を明記
- 2026-02-19: スコア計算をA×B方式（ブロック点×列点）に全面書き直し。用語定義（ブロック点/列点/列倍率）追加、mossBonus→列点(B)、comboBonus→2^n-1、full_clear_bonus→列点×5（乗算）、rensha増分+1、multiシールのパターン効果2倍化を明記
- 2026-02-18: 台本レリック効果を「スコア加算」から「ライン数加算」に変更（scriptBonus → scriptLineBonus、copyLineBonus追加、effectiveLinesCleared計算追加）
- 2026-02-17: コードに基づき全面更新（ボス条件おじゃまブロック数修正、全消しボーナス+100に修正、スコア計算式を全レリック・パターン・シール反映で更新、コンボカウンター追加、ゴールド報酬計算式更新、連射増分+2・全消しボーナス+100を反映、legiDisplayOrder適用順序を明記）
- 2026-02-17: レリック中心設計を反映（デッキ6枚化、利息、ショップ2+3構成、レリック売却、護符商品・購入フロー追加）
- 2026-02-06: ローグライト要素追加（ラウンドセット、ボス条件、パターン・シール効果、レリック効果、ショップ拡張、配置不可検出）
- 2026-02-02: デッキシステム、ラウンド制、ゴールド、ショップ、フェーズ判定を追加
- 2026-02-01: ミノシステム、生成ロジック、ライン消去、アニメーションを追加
- 2026-02-01: 初版作成
