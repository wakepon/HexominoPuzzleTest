# ゲームメカニクス

## 概要

ブロック配置パズルのコアメカニクス（ボード管理、ブロック配置、衝突判定）について説明する。

## ボード管理

### ボード構造

- 6x6のグリッド（`GRID_SIZE = 6`）
- 各セルは `Cell` 型で表現される
  - `filled: boolean` - セルが埋まっているかどうか

### 空ボード生成

- ゲーム開始時に全セルが空の状態でボードが生成される
- すべてのセルの `filled` が `false` で初期化される

### セル状態の取得

- 指定位置のセルを取得する機能
- 範囲外の座標を指定した場合は `null` を返す

## ブロック形状

### 定義済みブロック

現在3種類のブロックが定義されている:

1. **単一ブロック (1x1)**
   - 1セル分のブロック

2. **正方形ブロック (2x2)**
   - 4セルの正方形

3. **横長ブロック (3x1)**
   - 3セルの横並び

### ブロックデータ構造

- `PieceShape`: 2次元配列の真偽値（`true` = ブロックあり）
- 各ブロックには一意の `id` が割り当てられる

### ブロック情報取得

- ブロックのサイズ（幅・高さ）を取得できる
- ブロック内の有効セル数（`true` のセル数）を取得できる

## ブロック配置

### 配置処理

- 指定位置にブロックを配置する（immutableパターン）
- 新しいボードオブジェクトを返す（元のボードは変更しない）
- ブロック形状の各セルが `true` の位置に対応するボードセルを `filled: true` に設定する

### 前提条件

配置処理を実行する前に、必ず衝突判定で配置可能かチェックする必要がある。

## 衝突判定

### 配置可能性チェック

以下の条件をすべて満たす場合に配置可能と判定される:

1. **範囲内チェック**: ブロックのすべてのセルがボード範囲内に収まる
2. **重複チェック**: ブロックのセルと既に埋まっているセルが重複しない

### チェック処理

- ブロック形状の各セル（`true` のセル）に対して判定を実行
- 1つでも条件を満たさないセルがあれば配置不可と判定

### 座標変換

スクリーン座標（ピクセル単位）からボード座標（グリッド単位）への変換機能を提供:

- ドラッグ位置をボード上のグリッド位置に変換
- ボードオフセットとセルサイズを考慮した計算
- `Math.floor` で切り捨て処理

### ボード範囲チェック

- 指定座標がボード範囲内（0 ~ GRID_SIZE-1）かを判定する独立した関数

## ドラッグ&ドロップ

### ドラッグ開始

1. プレイヤーがブロックスロット上でマウス/タッチを開始
2. スロットインデックスと開始位置を記録
3. ドラッグ状態を有効化

### ドラッグ中

1. マウス/タッチ位置を追跡
2. 現在位置をスクリーン座標からボード座標に変換
3. 変換されたボード座標で配置可能性をチェック
4. プレビュー表示を更新

### ドラッグ終了

1. ドロップ時のボード座標を取得
2. 配置可能かチェック
   - **配置可能**: ブロックをボードに配置し、スロットから削除
   - **配置不可**: 何も変更せずドラッグ状態をクリア

## プレビュー表示

### プレビュー判定

- ドラッグ中のみプレビューを表示
- ボード座標が取得できている場合のみ表示
- 配置可能性に応じて色を変更

### プレビュー色

- **配置可能**: 半透明の茶色系（`previewValid`）
- **配置不可**: 半透明の赤色（`previewInvalid`）

### 描画範囲

- プレビューはボード範囲内のセルのみ描画
- ブロック形状の各 `true` セルに対応する位置に描画

## 関連ファイル

- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/boardLogic.ts` - ボード管理ロジック
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/collisionDetection.ts` - 衝突判定
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/pieceDefinitions.ts` - ブロック定義
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/components/renderer/previewRenderer.ts` - プレビュー描画

## 更新履歴

- 2026-02-01: 初版作成
