# ゲームメカニクス

## 概要

ブロック配置パズルのコアメカニクス（ボード管理、ブロック配置、衝突判定）について説明する。

## ボード管理

### ボード構造

- 6x6のグリッド（`GRID_SIZE = 6`）
- 各セルは `Cell` 型で表現される
  - `filled: boolean` - セルが埋まっているかどうか

### 空ボード生成

- ゲーム開始時に全セルが空の状態でボードが生成される
- すべてのセルの `filled` が `false` で初期化される

### セル状態の取得

- 指定位置のセルを取得する機能
- 範囲外の座標を指定した場合は `null` を返す

## ミノ形状システム

### ミノカテゴリ

ミノはセル数によって6つのカテゴリに分類される:

1. **モノミノ**: 1セル - 1種類
2. **ドミノ**: 2セル - 2種類（横・縦）
3. **トロミノ**: 3セル - 6種類
4. **テトロミノ**: 4セル - 19種類
5. **ペントミノ**: 5セル - 63種類
6. **ヘキソミノ**: 6セル - 216種類（35基本形 × 回転・反転）

**合計**: 307種類のミノ定義

### ミノ定義データ構造

- `MinoDefinition`: ミノの定義
  - `id`: ミノの識別子（例: `"hex-K20-m90"`）
  - `category`: カテゴリ（`'monomino'` ~ `'hexomino'`）
  - `shape`: 2次元配列の真偽値（`true` = ブロックあり）
  - `cellCount`: セル数

### ASCII形状定義

ミノ形状はASCIIアート形式で定義される:
- `#`: ブロックあり
- `.`: 空セル
- 各行の長さが異なる場合、最大幅に合わせて自動パディング

### ブロック生成

`Piece` オブジェクトは `MinoDefinition` から生成される:
- ユニークID: タイムスタンプ + 乱数で生成
- 形状: ミノ定義から継承

## ブロック配置

### 配置処理

- 指定位置にブロックを配置する（immutableパターン）
- 新しいボードオブジェクトを返す（元のボードは変更しない）
- ブロック形状の各セルが `true` の位置に対応するボードセルを `filled: true` に設定する

### 前提条件

配置処理を実行する前に、必ず衝突判定で配置可能かチェックする必要がある。

## 衝突判定

### 配置可能性チェック

以下の条件をすべて満たす場合に配置可能と判定される:

1. **範囲内チェック**: ブロックのすべてのセルがボード範囲内に収まる
2. **重複チェック**: ブロックのセルと既に埋まっているセルが重複しない

### チェック処理

- ブロック形状の各セル（`true` のセル）に対して判定を実行
- 1つでも条件を満たさないセルがあれば配置不可と判定

### 座標変換

スクリーン座標（ピクセル単位）からボード座標（グリッド単位）への変換機能を提供:

- ドラッグ位置をボード上のグリッド位置に変換
- ボードオフセットとセルサイズを考慮した計算
- `Math.floor` で切り捨て処理

### ボード範囲チェック

- 指定座標がボード範囲内（0 ~ GRID_SIZE-1）かを判定する独立した関数

## ドラッグ&ドロップ

### ドラッグ開始

1. プレイヤーがブロックスロット上でマウス/タッチを開始
2. スロットインデックスと開始位置を記録
3. ドラッグ状態を有効化

### ドラッグ中

1. マウス/タッチ位置を追跡
2. 現在位置をスクリーン座標からボード座標に変換
3. 変換されたボード座標で配置可能性をチェック
4. プレビュー表示を更新

### ドラッグ終了

1. ドロップ時のボード座標を取得
2. 配置可能かチェック
   - **配置可能**: ブロックをボードに配置し、スロットから削除
   - **配置不可**: 何も変更せずドラッグ状態をクリア

## プレビュー表示

### プレビュー判定

- ドラッグ中のみプレビューを表示
- ボード座標が取得できている場合のみ表示
- 配置可能性に応じて色を変更

### プレビュー色

- **配置可能**: 半透明の茶色系（`previewValid`）
- **配置不可**: 半透明の赤色（`previewInvalid`）

### 描画範囲

- プレビューはボード範囲内のセルのみ描画
- ブロック形状の各 `true` セルに対応する位置に描画

## ミノ生成システム

### カテゴリ重み

各カテゴリには重み（出現確率の比率）が設定されている:
- 重みに基づいてカテゴリをランダム選択
- 選択されたカテゴリ内からミノをランダム選択
- 3個のミノセットを生成

### 乱数生成器

2種類の乱数生成器を提供:
- `DefaultRandom`: `Math.random()` のラッパー（本番環境用）
- `SeededRandom`: シード対応（テスト用、Mulberry32アルゴリズム）

### 自動補充

全てのスロットが空になると、新しいミノセット（3個）が自動生成される。

## ライン消去システム

### ライン完成判定

- **行**: すべてのセルが埋まっている行を検出
- **列**: すべてのセルが埋まっている列を検出
- 複数ラインの同時検出が可能

### 消去対象セル決定

- 完成した行と列のセルを収集
- 重複するセル（行と列が交差する位置）は1回のみカウント
- `Set` を使用して重複を除去

### スコア計算

スコア = 消去されたセル数 × 消去されたライン数

例:
- 1行のみ消去（6セル） × 1ライン = 6点
- 1行 + 1列（11セル、交差1セル） × 2ライン = 22点

### ライン消去実行

- 消去対象セルを `filled: false` に設定
- 新しいボードオブジェクトを返す（immutable）

## 消去アニメーション

### アニメーション効果

- 回転: 0度から180度まで
- 上昇: セルが上方向に移動
- 縮小: スケールが1.0から0.0に変化
- イージング: ease-out cubic

### アニメーション状態

- `isAnimating`: アニメーション中フラグ
- `cells`: 消去対象セル配列
- `startTime`: 開始時刻（タイムスタンプ）
- `duration`: 継続時間

### 描画タイミング

- アニメーション中は `requestAnimationFrame` でループ
- 進行度に応じてセルを変形・描画
- 完了時に `END_CLEAR_ANIMATION` アクションで実際の消去を実行

## 関連ファイル

- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/boardLogic.ts` - ボード管理ロジック
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/collisionDetection.ts` - 衝突判定
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/minoDefinitions.ts` - ミノ定義
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/pieceGenerator.ts` - ミノ生成ロジック
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/lineLogic.ts` - ライン消去とスコア計算
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/lib/game/random.ts` - 乱数生成器
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/components/renderer/previewRenderer.ts` - プレビュー描画
- `/Users/kenwatanabe/Projects/HexominoPuzzleTest/src/components/renderer/clearAnimationRenderer.ts` - 消去アニメーション描画

## 更新履歴

- 2026-02-01: 初版作成
- 2026-02-01: ミノシステム、生成ロジック、ライン消去、アニメーションを追加
