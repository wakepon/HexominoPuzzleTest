# 実装タスク一覧（縦スライスアプローチ）

## 概要

- **目的**: Architecture.mdの設計に基づき、ローグライト要素を追加実装
- **技術スタック**: React + TypeScript + Canvas API
- **アプローチ**: 縦スライス（機能単位で型→ロジック→UIを一気に実装）

## 現在の実装状況

### 実装済み
- 基本パズルメカニクス（ボード、ピース配置、ライン消去）
- デッキシステム（基本機能）
- ラウンドシステム（基本的な進行）
- ショップ（基本機能: MinoIdベースの購入）
- ドラッグ&ドロップ操作
- Canvas描画（boardRenderer, pieceRenderer等）

### 未実装（本計画のスコープ）
- Effect層（パターン、シール、レリック）
- PlayerState（所持レリック、ゴールド管理の拡張）
- イベントシステム（効果計算用）
- ボス条件（おじゃまブロック、省エネ、手札2枚）
- 拡張スコア計算（パターン/シール/レリック効果）

---

## スライス1: Effect基盤 + パターン表示
**動作確認**: パターン付きブロックがショップに表示され、購入するとデッキに追加され、配置時に視覚的にパターンが表示される

| # | タスク | 説明 | ステータス |
|---|--------|------|:----------:|
| 1.1 | Effect型定義 | `src/lib/game/Domain/Effect/` にPatternId, SealId, RelicId, PatternDefinition, SealDefinition, RelicDefinition を作成 | ✅ 完了 |
| 1.2 | BlockData拡張 | `BlockData` と `BlockDataMap` の実装（Piece.blocksで使用） | ✅ 完了 |
| 1.3 | Piece型拡張 | `Piece.blocks` と `Piece.blockSetId` を必須化、関連ファクトリ関数を更新 | ✅ 完了 |
| 1.4 | Cell型拡張 | `Cell` に pattern, seal, blockSetId フィールドを追加 | ✅ 完了 |
| 1.5 | PieceService拡張 | パターン付きPiece生成関数 `createPieceWithPattern()` を追加 | ✅ 完了 |
| 1.6 | ショップ型拡張 | `ShopItem` を `BlockShopItem | RelicShopItem` に変更、Piece直接保持 | ✅ 完了 |
| 1.7 | ショップロジック拡張 | パターン付きブロックを生成してショップに追加 | ✅ 完了 |
| 1.8 | BoardService拡張 | `placePieceOnBoard()` でBlockData（パターン）をCellに反映 | ✅ 完了 |
| 1.9 | cellRenderer拡張 | パターン別の色/スタイルでセルを描画 | ✅ 完了 |
| 1.10 | shopRenderer拡張 | パターン付きブロックの表示（パターン名、視覚効果） | ✅ 完了 |
| 1.11 | ビルド確認 | `npx tsc --noEmit` でエラーがないことを確認 | ✅ 完了 |

---

## スライス2: シールシステム
**動作確認**: シール付きブロックがショップに表示され、購入・配置後にシールが盤面上に表示される

| # | タスク | 説明 | ステータス |
|---|--------|------|:----------:|
| 2.1 | シール付きPiece生成 | `createPieceWithSeal()` 関数を追加（ランダム位置にシール付与） | ✅ 完了 |
| 2.2 | ショップにシール商品追加 | ショップ生成時にシール付きブロックを含める | ✅ 完了 |
| 2.3 | BoardService拡張 | `placePieceOnBoard()` でシール情報をCellに反映 | ✅ 完了 |
| 2.4 | cellRenderer拡張 | シールアイコン描画（G, +5, ×2, 石） | ✅ 完了 |
| 2.5 | shopRenderer拡張 | シール付きブロックの表示（シール位置ハイライト） | ✅ 完了 |
| 2.6 | ビルド確認 | `npx tsc --noEmit` でエラーがないことを確認 | ✅ 完了 |

---

## スライス3: パターン効果計算
**動作確認**: パターン付きブロックを消去した際に、正しいスコアボーナスが加算される

| # | タスク | 説明 | ステータス |
|---|--------|------|:----------:|
| 3.1 | PatternEffectHandler | パターン効果計算（enhanced, aura, moss）の純粋関数を作成 | ⬜ 未着手 |
| 3.2 | LineService拡張 | `calculateScore()` でパターン効果を考慮したスコア計算 | ⬜ 未着手 |
| 3.3 | GameReducer拡張 | ライン消去時にパターン効果を反映 | ⬜ 未着手 |
| 3.4 | スコア表示拡張 | ボーナス内訳表示（オプション） | ⬜ 未着手 |
| 3.5 | ビルド確認 | `npx tsc --noEmit` でエラーがないことを確認 | ⬜ 未着手 |

---

## スライス4: シール効果計算
**動作確認**: ゴールドシール付きブロック消去でゴールド獲得、スコアシールでスコアボーナス

| # | タスク | 説明 | ステータス |
|---|--------|------|:----------:|
| 4.1 | SealEffectHandler | シール効果計算（gold, score, multi, stone）の純粋関数を作成 | ⬜ 未着手 |
| 4.2 | LineService拡張 | 石シール付きセルをライン消去対象から除外 | ⬜ 未着手 |
| 4.3 | LineService拡張 | `calculateScore()` でシール効果（multi, score）を反映 | ⬜ 未着手 |
| 4.4 | GameReducer拡張 | ゴールドシール消去時にゴールド加算 | ⬜ 未着手 |
| 4.5 | ビルド確認 | `npx tsc --noEmit` でエラーがないことを確認 | ⬜ 未着手 |

---

## スライス5: レリックシステム基盤
**動作確認**: ショップでレリックを購入し、所持レリックとして画面に表示される

| # | タスク | 説明 | ステータス |
|---|--------|------|:----------:|
| 5.1 | PlayerState型定義 | `src/lib/game/Domain/Player/PlayerState.ts` を作成 | ⬜ 未着手 |
| 5.2 | GameState拡張 | `player: PlayerState` フィールドを追加 | ⬜ 未着手 |
| 5.3 | PlayerReducer作成 | レリック追加/削除のReducer | ⬜ 未着手 |
| 5.4 | ショップにレリック追加 | `RelicShopItem` を生成してショップに含める | ⬜ 未着手 |
| 5.5 | 購入ロジック | レリック購入時にPlayerStateに追加 | ⬜ 未着手 |
| 5.6 | relicPanelRenderer作成 | 画面上部に所持レリックアイコンを描画 | ⬜ 未着手 |
| 5.7 | shopRenderer拡張 | レリック商品の表示（アイコン、説明、レアリティ） | ⬜ 未着手 |
| 5.8 | ビルド確認 | `npx tsc --noEmit` でエラーがないことを確認 | ⬜ 未着手 |

---

## スライス6: レリック効果計算
**動作確認**: 各レリック効果が正しく発動（全消しボーナス、小さな幸運、連鎖の達人）

| # | タスク | 説明 | ステータス |
|---|--------|------|:----------:|
| 6.1 | RelicEffectHandler | レリック効果計算の純粋関数を作成 | ⬜ 未着手 |
| 6.2 | ScoreCalculator統合 | パターン/シール/レリック効果を統合したスコア計算 | ⬜ 未着手 |
| 6.3 | GameReducer拡張 | レリック効果をスコア計算に反映 | ⬜ 未着手 |
| 6.4 | 効果発動表示 | レリック発動時のエフェクト描画 | ⬜ 未着手 |
| 6.5 | ビルド確認 | `npx tsc --noEmit` でエラーがないことを確認 | ⬜ 未着手 |

---

## スライス7: ラウンドセット + ボス条件
**動作確認**: 3ラウンド毎にボス条件が適用され、画面に表示される

| # | タスク | 説明 | ステータス |
|---|--------|------|:----------:|
| 7.1 | RoundTypes拡張 | `RoundType`, `BossCondition`, `RoundInfo` を定義 | ⬜ 未着手 |
| 7.2 | RoundService拡張 | ラウンド情報計算、ボス条件抽選 | ⬜ 未着手 |
| 7.3 | GameState拡張 | `roundInfo: RoundInfo` に変更 | ⬜ 未着手 |
| 7.4 | ボス条件適用 | おじゃまブロック配置、省エネ（配置数減）、手札2枚 | ⬜ 未着手 |
| 7.5 | roundRenderer拡張 | ラウンドタイプ、ボス条件の表示 | ⬜ 未着手 |
| 7.6 | ビルド確認 | `npx tsc --noEmit` でエラーがないことを確認 | ⬜ 未着手 |

---

## スライス8: ショップ価格計算 + UI改善
**動作確認**: パターン/シール/レリックに応じた価格がショップに表示される

| # | タスク | 説明 | ステータス |
|---|--------|------|:----------:|
| 8.1 | ShopPriceCalculator | Piece/レリックの価格自動計算 | ⬜ 未着手 |
| 8.2 | ショップUI改善 | 価格表示、購入可否のスタイル | ⬜ 未着手 |
| 8.3 | セール機能 | 一部商品にセールフラグ | ⬜ 未着手 |
| 8.4 | ビルド確認 | `npx tsc --noEmit` でエラーがないことを確認 | ⬜ 未着手 |

---

## スライス9: イベントシステム（オプション）
**動作確認**: イベントバス経由で効果が発火し、ログで確認できる

| # | タスク | 説明 | ステータス |
|---|--------|------|:----------:|
| 9.1 | GameEvent型定義 | イベント型（PiecePlaced, LinesCompleted等）を定義 | ⬜ 未着手 |
| 9.2 | EventBus実装 | イベント登録・発火・ログ機能 | ⬜ 未着手 |
| 9.3 | EffectHandlers統合 | イベントハンドラとしてエフェクト計算を登録 | ⬜ 未着手 |
| 9.4 | useGameEvents hook | イベントバス連携hook | ⬜ 未着手 |
| 9.5 | ビルド確認 | `npx tsc --noEmit` でエラーがないことを確認 | ⬜ 未着手 |

---

## スライス10: ゲームリセット + 永続化
**動作確認**: ゲームオーバー時にレリック/ゴールドがリセット、進行状況が正しく保存・復元される

| # | タスク | 説明 | ステータス |
|---|--------|------|:----------:|
| 10.1 | リセット処理 | ゲームオーバー時のPlayerState/ショップ/ラウンドリセット | ⬜ 未着手 |
| 10.2 | 永続化（オプション） | LocalStorageへの保存・復元 | ⬜ 未着手 |
| 10.3 | ビルド確認 | `npx tsc --noEmit` でエラーがないことを確認 | ⬜ 未着手 |

---

## 進捗サマリー

| スライス | 完了タスク | 総タスク | 進捗 |
|---------|-----------|---------|------|
| 1: Effect基盤 + パターン表示 | 11 | 11 | 100% |
| 2: シールシステム | 6 | 6 | 100% |
| 3: パターン効果計算 | 0 | 5 | 0% |
| 4: シール効果計算 | 0 | 5 | 0% |
| 5: レリックシステム基盤 | 0 | 8 | 0% |
| 6: レリック効果計算 | 0 | 5 | 0% |
| 7: ラウンドセット + ボス条件 | 0 | 6 | 0% |
| 8: ショップ価格計算 + UI改善 | 0 | 4 | 0% |
| 9: イベントシステム（オプション） | 0 | 5 | 0% |
| 10: ゲームリセット + 永続化 | 0 | 3 | 0% |
| **合計** | **17** | **58** | **29%** |

---

## 各スライスの実装フロー

1. 必要な型定義を追加
2. 必要なロジックを実装
3. 必要なUIコンポーネント/Rendererを実装
4. GameReducerに統合
5. ビルド確認（`npx tsc --noEmit`）
6. 画面で動作確認（`npm run dev`）
7. 問題があれば修正
8. 次のスライスへ

---

## 依存関係

```
スライス1 (Effect基盤)
    │
    ├──→ スライス2 (シール)
    │       │
    │       └──→ スライス4 (シール効果)
    │
    └──→ スライス3 (パターン効果)

スライス5 (レリック基盤)
    │
    └──→ スライス6 (レリック効果)

スライス7 (ラウンドセット) ← 独立

スライス8 (価格計算) ← スライス1,2,5 に依存

スライス9 (イベントシステム) ← オプション、後から導入可能

スライス10 (リセット+永続化) ← 全スライス完了後
```

---

## 注意事項

- **各スライス完了後に画面で動作確認**を行う
- **イベントシステム（スライス9）はオプション** - 現在の直接呼び出し方式でも動作する
- **テストは重要ロジックのみ** - 指示があるまでテストは書かない
- **既存コードへの影響を最小化** - 型を拡張する際はオプショナルフィールドを活用
- **Architecture.mdの設計を尊重** - 型定義・ディレクトリ構造は設計書に従う
