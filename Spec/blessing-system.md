# 加護システム

## 概要

- **加護（Blessing）**: ピース上のブロックに付与される効果。消去時にセルにバフとして刻まれる
- **バフ（Buff）**: セル上の永続効果。消去後もセルに残り、以後そのセルで消去されるブロックに効果を与える
- **付与方法**: ショップで購入（一定確率でランダム付与）
- **効果タイミング**: 加護付きブロックの消去時にセルへバフが刻まれ、以後そのセルで消去されるブロックに効果が適用される

加護はブロックに付与されるが、効果の対象はセル（盤面）。ブロックが消去されると加護がバフに変換されてセルに残り、ラン中永続する。シールが「ブロックへの即時効果（消費型）」であるのに対し、加護は「セルへの永続効果（投資型）」。

パターンについては [pattern-system.md](./pattern-system.md)、シールについては [seal-system.md](./seal-system.md) を参照。

---

## エフェクト4層構造における位置づけ

| 層 | 付与先 | 付与元 | 寿命 | 効果タイミング |
|----|--------|--------|------|-------------|
| レリック | プレイヤー | ショップ直接購入 | ラン永続 | 自動 |
| パターン | ピース全体 | ピースに付与済み | 配置〜消去 | 配置時/消去時 |
| シール | ブロック1個 | ピースに付与済み | 配置〜消去 | 消去時 |
| **加護→バフ** | **ブロック1個→セル** | **ピースに付与済み** | **消去で変換→ラン永続** | **そのセルで次回以降の消去時** |

**対称構造:**

|  | 永続（投資型） | 一時（消費型） |
|--|---------------|-------------|
| プレイヤー / ピース | レリック | パターン |
| セル / ブロック | **バフ** | シール |

---

## 加護とバフの概念分離

### 加護（Blessing）

- **定義場所**: `Domain/Effect/Blessing.ts`
- **役割**: ピース上のブロックに付与される「バフ予約券」
- **寿命**: ブロック配置〜消去まで（消去時にバフに変換）
- **種類**: 4種（power, gold, chain, phase）

### バフ（Buff）

- **定義場所**: `Domain/Effect/Buff.ts`
- **役割**: セル上の永続効果
- **寿命**: ラン永続（ゲームオーバーでリセット）
- **種類**: 4種（enhancement, gold_mine, pulsation, phase）

### 加護→バフの変換マッピング

| 加護（Blessing） | バフ（Buff） | 変換タイミング |
|--------------|-----------|-----------|
| power | enhancement | ブロック消去時 |
| gold | gold_mine | ブロック消去時 |
| chain | pulsation | ブロック消去時 |
| phase | phase | ブロック消去時（確率） |

---

## 基本フロー

```
1. ショップでピースを購入 → 加護（Blessing）がブロックに付いている
2. ピースを盤面に配置 → Cell.blockBlessing フィールドに加護IDが保存される
3. ライン消去でブロックが消える
4. stampBlessingsOnBoard() が実行され、加護をバフに変換
5. セルの buff/buffLevel フィールドが更新される
6. 以後、そのセルに配置→消去されるブロックがバフの恩恵を受ける
```

---

## シールとの関係

### 併存可能

1ブロックにシールと加護の両方が付与可能。

- シール = **ブロック**への効果（ブロックが消えると消失）
- 加護 = **セル**への効果（ブロックが消えた後にバフとして残る）
- 対象が異なる（ブロック vs セル）ので、両方付いていても概念的に矛盾しない

例: 「multiシール + 力の加護」のブロック
→ 消去時: multiでスコア2倍（シール効果、消費）+ セルに増強バフが刻まれる（永続投資）

例: 「透過バフ」のセル
→ 既にブロックがあっても、そのセルに新しいブロックを重ねて配置できる（※配置ルール効果は未実装）

### ピースの付与構成

```
ピース = パターン(0-1) + シール(ピース中0-1ブロック) + 加護(ピース中0-1ブロック)
```

- パターン・シール・加護の付与判定はそれぞれ独立して行われる
- シールと加護は同じブロックにも、別ブロックにも付きうる

---

## 加護一覧（全4種）

### 力の加護 (power) → 増強バフ (enhancement)

| 項目 | 値 |
|------|-----|
| 加護ID | `power` |
| バフID | `enhancement` |
| 名前 | 力の加護 → 増強 |
| 説明 | 消滅時にセルに増強を付与する |
| 効果対象 | ブロック点(A) |
| 最大レベル | 無限 |

**効果**: このセルで消去されるブロックのブロック点(A)に、バフレベルに応じた値を加算する。

**バフ効果**: ブロック点 + (0.5 × Lv)

---

### 金の加護 (gold) → 金鉱バフ (gold_mine)

| 項目 | 値 |
|------|-----|
| 加護ID | `gold` |
| バフID | `gold_mine` |
| 名前 | 金の加護 → 金鉱 |
| 説明 | 消滅時にセルに金鉱を付与する |
| 効果対象 | ゴールド |
| 最大レベル | 4 |

**効果**: このセルでブロックが消去されるたびに、確率でゴールドを獲得する。スコア計算には影響しない。

**バフ効果**: (Lv / 4) の確率で 1G 獲得

---

### 連の加護 (chain) → 脈動バフ (pulsation)

| 項目 | 値 |
|------|-----|
| 加護ID | `chain` |
| バフID | `pulsation` |
| 名前 | 連の加護 → 脈動 |
| 説明 | 消滅時にセルに脈動を付与する |
| 効果対象 | 列点(B) |
| 最大レベル | 無限 |

**効果**: このセルを含むラインが完成した時、列点(B)に加算する。

**バフ効果**: 列点 + (0.2 × Lv)

---

### 透の加護 (phase) → 透過バフ (phase)

| 項目 | 値 |
|------|-----|
| 加護ID | `phase` |
| バフID | `phase` |
| 名前 | 透の加護 → 透過 |
| 説明 | 消滅時に確率でセルに透過を付与する |
| 効果対象 | 配置ルール |
| 最大レベル | 1 |
| 付与確率 | 25% |

**効果**: この透過バフが刻まれたセルにすでにブロックがある場合でも、そのセルに重ねてブロックを配置できるようになる。重ねて配置した場合、既存のブロックは上書きされる（新しいブロックのblockSetIdに置き換わる）。

> **※ 配置ルール効果は未実装**: CollisionServiceにphaseバフの判定ロジックは未実装。バフの刻印処理（stampBlessingsOnBoard）のみ実装済み。

**配置ルールへの影響**（設計意図）:

- CollisionService の配置判定で、`phase`バフのあるセルは「空き」として扱う
- 重ね配置時、既存ブロックの blockSetId は新しいブロックの blockSetId で上書きされる
- 既存ブロックのシールや加護情報は失われる（セルのバフは維持される）
- obstacleセルには効果なし（obstacleはバフを封印する）

---

## レベルシステム（重ね掛け）

### 基本ルール

- 同じセルに**同種**の加護ブロックが消去されるとレベルアップする
- 同じセルに**異種**の加護ブロックが消去されても付かない（既存のバフは維持）
- 上限は**バフ定義のmaxLevel**に従う（enhancement/pulsation: 無限、gold_mine: 4、phase: 1）
- 1セルに付けられるバフは**1種類のみ**

→ 「このセルをどのバフで育てるか」を最初の1回で決めるコミットメントが発生する。

### レベルアップ表

| 現在 | 加護ブロック消去 | multi付き加護ブロック消去 |
|------|--------------|---------------------|
| なし | → Lv1 | → Lv2 |
| Lv1 | → Lv2 | → Lv3 |
| Lv2 | → Lv3 | → Lv4 |
| Lv3 | → Lv4 | → Lv5 |
| ... | ... | ... |

**注**: gold_mine と phase のみ上限あり（gold_mine: Lv4、phase: Lv1）

### multiシールとのシナジー

multiシール付きの加護ブロックが消去された場合、バフが2回独立して適用される。

- Lv0 → Lv2（一気に2段階）
- Lv1 → Lv3（一気に2段階）

→ 「multi + 加護」ブロックは一撃でLv2に到達できる大当たり。

### 透の加護の特別ルール

透の加護のみ、multiシールの効果が異なる:

- **通常**: 25%の確率で1回抽選 → 失敗すると何も起きない
- **multi付き**: 25%の確率で2回独立抽選 → 2回成功でLv1（上限なので1回でも最大）

透の加護はレアケースであり、multiシールとの組み合わせでも確率は25% × 2回抽選のみ。

### 集中 vs 分散の投資判断

| 戦略 | メリット | リスク |
|------|---------|-------|
| **集中**（1セルを高レベルに） | 高リターン（高Lv効果） | obstacle被弾時の損失が大きい |
| **分散**（複数セルをLv1ずつ） | リスク分散 | 個々の効果は低い |
| **バランス型** | 中間 | 中間 |

---

## 永続性ルール

- ラン中永続（ゲームオーバーでリセット）
- ブロックの配置/消去ではバフは消えない（セルに残り続ける）
- obstacleが上に乗るとバフ効果は**無効化**される（obstacleが除去されれば復活）
- 1セル1種のバフ（同種のみレベルアップ、異種は無効）
- 上限はバフ定義のmaxLevelに従う

---

## ボスのobstacleとの相互作用

obstacle: ボスラウンド開始時にランダムな4セルに消去不可ブロックを配置。

- バフセルにobstacleが乗ると、バフ効果は無効化される
- obstacleは消去不可のため、事実上「バフが封印される」
- バフ自体は消滅しない（obstacleが何らかの手段で除去されれば復活）

### 被害確率（6×6 = 36セル、obstacle = 4セル）

| バフセル数 | 1つ以上被害を受ける確率 | 備考 |
|-----------|---------------------|------|
| 1セル | ≈ 11% | 集中投資時。低確率だが被害時の損失大 |
| 3セル | ≈ 30% | 適度なリスク |
| 6セル | ≈ 52% | 分散投資時。被害率は高いが1セルあたりの損失は小 |

---

## ショップでの加護出現

パターン・シール・加護付与確率はミノサイズに関わらず一律である。それぞれ独立して判定される。

| 商品枠 | 対象ミノカテゴリ | パターン付与確率 | シール付与確率 | 加護付与確率 |
|--------|----------------|--------------|--------------|-------------|
| 小中枠 | モノミノ/ドミノ/トリミノ/テトロミノ | 40% | 25% | 15% |
| 中大枠 | テトロミノ/ペントミノ/ヘキソミノ | 40% | 25% | 15% |

- 付与される加護の種類はショップ出現可能なものからランダムに選択
- 加護はピース中の1ブロックにのみ付与される
- シールと同じブロックに付与されることもある

**ショップ出現可能な加護**: power, gold, chain, phase（全4種）

---

## スコア計算フローへの影響

既存のA×B方式にバフの効果が加わる:

```
1. 消去対象セルを収集（filterClearableCells でフィルタリング）
2. バフ効果を計算 ← NEW
   - 各消去セルについて、そのセルにバフがあるか確認
   - enhancement: ブロック点(A)に +0.5×Lv 加算
   - gold_mine: Lv/4 の確率でゴールドに +1G 加算（スコア計算外）
   - pulsation: 列点(B)に +0.2×Lv 加算
   - phase: 配置ルールに影響（スコア計算時には効果なし）
3. パターン効果を計算
4. シール効果を計算
5. レリック効果を計算
6. 最終スコア = Math.floor(A × B)
```

---

## 視覚表現

### 盤面上のバフ表示

| 状態 | 表現 |
|------|------|
| 空きセル + バフLv1 | セル背景に淡いシンボル |
| 空きセル + バフLv2+ | やや明るいシンボル + レベル表示 |
| 空きセル + バフLv高 | はっきりしたシンボル + 微かな光 |
| ブロックが乗っている + バフ | セルの縁取りが光る（Lvで明るさ変化） |
| obstacleが乗っている + バフ | バフマーカーが暗く表示（封印状態） |

### ブロック上の加護マーク

- シールと同様にブロック上にシンボル表示
- シールとは色味やデザインで区別する（シール = 即時感のある色、加護 = 永続感のある落ち着いた色）

**加護シンボル**: 力、金、連、透

---

## データ構造

### Cell型（Domain/Board/Cell.ts）

```typescript
interface Cell {
  readonly filled: boolean
  readonly blockSetId: BlockSetId | null
  readonly pattern: PatternId | null
  readonly seal: SealId | null
  readonly chargeValue: number
  readonly buff: BuffType | null           // バフ種別
  readonly buffLevel: number               // バフレベル
  readonly blockBlessing: BlessingId | null // ブロック配置時の加護（一時）
}
```

- `buff/buffLevel`: セル上の永続効果（消去後も残る）
- `blockBlessing`: ブロック配置時の加護（消去時にバフとして刻まれる一時フィールド）

### BlockData型（Domain/Piece/BlockData.ts）

```typescript
interface BlockData {
  readonly pattern: PatternId | null
  readonly seal: SealId | null
  readonly blessing: BlessingId | null  // ピース上のブロックに付与される加護
}
```

---

## バフ効果計算

### BlessingEffectHandler（Domain/Effect/BlessingEffectHandler.ts）

主要関数:

1. **stampBlessingsOnBoard()**
   - ブロック消去時にセルへバフを刻む（加護→バフ変換）
   - multiシールの有無を判定し、2回独立抽選（透の加護のみ）または2回レベルアップ（それ以外）
   - 呼び出し元: GameReducer の `ANIMATION/END_CLEAR` アクション

2. **calculateBuffScoreEffects()**
   - バフがスコアに与える効果を計算
   - 消去対象セルの下にあるバフを参照
   - obstacleパターンが乗っているセルのバフは無効化
   - 呼び出し元: LineService の calculateScoreWithEffects()

3. **calculateBuffLevelUp()**
   - レベルアップ計算（同種: +1、異種: 変更なし、新規: Lv1）
   - multiシールの効果は呼び出し側で抽選回数として表現

---

## 関連ファイル

- `src/lib/game/Domain/Effect/Blessing.ts` — 加護定義・マスターデータ
- `src/lib/game/Domain/Effect/Buff.ts` — バフ定義・マスターデータ
- `src/lib/game/Domain/Effect/BlessingEffectHandler.ts` — 加護→バフ変換・バフ効果計算（純粋関数）
- `src/lib/game/Domain/Board/Cell.ts` — Cell構造（buff/buffLevel/blockBlessing）
- `src/lib/game/Domain/Piece/BlockData.ts` — BlockData構造（blessing）
- `src/lib/game/Services/LineService.ts` — スコア計算にバフ効果を統合
- `src/lib/game/Services/ShopService.ts` — ショップ商品生成・加護付与確率
- `src/lib/game/Services/PieceService.ts` — 加護付きピース生成関数
- `src/lib/game/State/Reducers/GameReducer.ts` — バフスタンプ処理（ANIMATION/END_CLEAR）
- `src/lib/game/Data/Constants.ts` — 加護・バフ関連定数

---

## 更新履歴

- 2026-02-22: 透過バフ（phase）の配置ルール効果が未実装である旨を注記
- 2026-02-20: 初版作成
- 2026-02-20: 加護とバフの概念分離に対応して全面更新
  - 加護（Blessing）→バフ（Buff）への変換フロー明記
  - 透の加護の確率抽選ルール追加（multiシール時の独立抽選）
  - それ以外の加護は確定付与・multiシール時2回レベルアップ
  - バフレベル上限（enhancement/pulsation: 無限、gold_mine: 4、phase: 1）
  - バフ効果値の明記（enhancement: +0.5×Lv、pulsation: +0.2×Lv、gold_mine: Lv/4確率で1G）
  - セル型のフィールド名更新（buff/buffLevel/blockBlessing）
  - 関連ファイル・関数名を実装に合わせて更新
