# 加護システム

## 概要

- **対象**: ブロックセット内の個別セル（1セルのみ） → 消去後にセルへ永続効果として残る
- **付与方法**: ショップで購入（サイズに応じた確率でランダム付与。シールと独立して判定）
- **効果タイミング**: 加護付きブロックの消去時にセルへ加護が刻まれ、以後そのセルで消去されるブロックに効果が適用される

加護はブロックに付与されるが、効果の対象はセル（盤面）。ブロックが消去されると加護だけがセルに残り、ラン中永続する。シールが「ブロックへの即時効果（消費型）」であるのに対し、加護は「セルへの永続効果（投資型）」。

パターンについては [pattern-system.md](./pattern-system.md)、シールについては [seal-system.md](./seal-system.md) を参照。

---

## エフェクト4層構造における位置づけ

| 層 | 付与先 | 付与元 | 寿命 | 効果タイミング |
|----|--------|--------|------|-------------|
| レリック | プレイヤー | ショップ直接購入 | ラン永続 | 自動 |
| パターン | ピース全体 | ピースに付与済み | 配置〜消去 | 配置時/消去時 |
| シール | ブロック1個 | ピースに付与済み | 配置〜消去 | 消去時 |
| **加護** | **ブロック1個→セル** | **ピースに付与済み** | **消去で誕生→ラン永続** | **そのセルで次回以降の消去時** |

**対称構造:**

|  | 永続（投資型） | 一時（消費型） |
|--|---------------|-------------|
| プレイヤー / ピース | レリック | パターン |
| セル / ブロック | **加護** | シール |

---

## シールとの関係

### 併存可能

1ブロックにシールと加護の両方が付与可能。

- シール = **ブロック**への効果（ブロックが消えると消失）
- 加護 = **セル**への効果（ブロックが消えた後に残る）
- 対象が異なる（ブロック vs セル）ので、両方付いていても概念的に矛盾しない

例: 「multiシール + 力の加護」のブロック
→ 消去時: multiでスコア2倍（シール効果、消費）+ セルに力の加護が残る（永続投資）

### ピースの付与構成

```
ピース = パターン(0-1) + シール(ピース中0-1ブロック) + 加護(ピース中0-1ブロック)
```

- パターン・シール・加護の付与判定はそれぞれ独立して行われる
- シールと加護は同じブロックにも、別ブロックにも付きうる

---

## 基本フロー

```
1. ショップでピースを購入 → 加護がブロックに付いている
2. ピースを盤面に配置
3. ライン消去でブロックが消える
4. 消えたセルに「加護」が永続的に残る
5. 以後、そのセルに配置→消去されるブロックが加護の恩恵を受ける
```

---

## 加護一覧（全5種）

### 力の加護 (power)

| 項目 | 値 |
|------|-----|
| type | `power` |
| 名前 | 力の加護 |
| 説明 | このセルのブロック点+1 |
| 効果対象 | ブロック点(A) |

**効果**: このセルで消去されるブロックのブロック点(A)に、加護レベルに応じた値を加算する。

| Lv | 効果 |
|----|------|
| Lv1 | ブロック点+1 |
| Lv2 | ブロック点+2 |
| Lv3 | ブロック点+3 |

---

### 金の加護 (gold)

| 項目 | 値 |
|------|-----|
| type | `gold` |
| 名前 | 金の加護 |
| 説明 | このセルで消去すると+1G |
| 効果対象 | ゴールド |

**効果**: このセルでブロックが消去されるたびに、加護レベルに応じたゴールドを獲得する。スコア計算には影響しない。

| Lv | 効果 |
|----|------|
| Lv1 | +1G |
| Lv2 | +2G |
| Lv3 | +3G |

---

### 連の加護 (chain)

| 項目 | 値 |
|------|-----|
| type | `chain` |
| 名前 | 連の加護 |
| 説明 | このセルを含むライン完成時、ライン点+1 |
| 効果対象 | 列点(B) |

**効果**: このセルを含むラインが完成した時、列点(B)に加護レベルに応じた値を加算する。

| Lv | 効果 |
|----|------|
| Lv1 | 列点+1 |
| Lv2 | 列点+2 |
| Lv3 | 列点+3 |

---

### 導の加護 (guide)

| 項目 | 値 |
|------|-----|
| type | `guide` |
| 名前 | 導の加護 |
| 説明 | このセルのブロックのパターン効果を強化 |
| 効果対象 | パターン効果 |

**効果**: このセルで消去されるブロックのパターン効果を、加護レベルに応じた段階分だけ強化する（例: enhanced +2 が導の加護Lv1で +3 になる）。

| Lv | 効果 |
|----|------|
| Lv1 | パターン効果+1段階 |
| Lv2 | パターン効果+2段階 |
| Lv3 | パターン効果+3段階 |

---

### 癒の加護 (heal)

| 項目 | 値 |
|------|-----|
| type | `heal` |
| 名前 | 癒の加護 |
| 説明 | このセルで消去すると手数回復 |
| 効果対象 | 手数（ハンド） |

**効果**: このセルでブロックが消去された時、手数を回復する。手数回復は強力なため、確率制で発動する。

| Lv | 効果 |
|----|------|
| Lv1 | 30%の確率で手数+1 |
| Lv2 | 60%の確率で手数+1 |
| Lv3 | 確定で手数+1 |

※ バランス調整が必要な可能性あり

---

## レベルシステム（重ね掛け）

### 基本ルール

- 同じセルに**同種**の加護ブロックが消去されるとレベルアップする
- 同じセルに**異種**の加護ブロックが消去されても付かない（既存の加護は維持）
- 上限は**Lv3**
- 1セルに付けられる加護は**1種類のみ**

→ 「このセルをどの加護で育てるか」を最初の1回で決めるコミットメントが発生する。

### レベルアップ表

| 現在 | 加護ブロック消去 | multi付き加護ブロック消去 |
|------|--------------|---------------------|
| なし | → Lv1 | → Lv2 |
| Lv1 | → Lv2 | → Lv3 |
| Lv2 | → Lv3 | → Lv3（上限） |
| Lv3 | 変化なし（上限） | 変化なし（上限） |

### multiシールとのシナジー

multiシール付きの加護ブロックが消去された場合、加護が2段階分適用される。

- Lv0 → Lv2（一気に2段階）
- Lv1 → Lv3（一気に上限到達）

→ 「multi + 加護」ブロックは一撃でLv2に到達できる大当たり。

### 集中 vs 分散の投資判断

| 戦略 | メリット | リスク |
|------|---------|-------|
| **集中**（1セルをLv3に） | 高リターン（Lv3効果） | obstacle被弾時の損失が大きい |
| **分散**（3セルをLv1ずつ） | リスク分散 | 個々の効果はLv1 |
| **バランス型** | 中間 | 中間 |

---

## 永続性ルール

- ラン中永続（ゲームオーバーでリセット）
- ブロックの配置/消去では加護は消えない（セルに残り続ける）
- obstacleが上に乗ると加護効果は**無効化**される（obstacleが除去されれば復活）
- 1セル1種の加護（同種のみレベルアップ、異種は無効）
- Lv3が上限

---

## ボスのobstacleとの相互作用

obstacle: ボスラウンド開始時にランダムな4セルに消去不可ブロックを配置。

- 加護セルにobstacleが乗ると、加護効果は無効化される
- obstacleは消去不可のため、事実上「加護が封印される」
- 加護自体は消滅しない（obstacleが何らかの手段で除去されれば復活）

### 被害確率（6×6 = 36セル、obstacle = 4セル）

| 加護セル数 | 1つ以上被害を受ける確率 | 備考 |
|-----------|---------------------|------|
| 1セル | ≈ 11% | 集中投資時。低確率だが被害時の損失大 |
| 3セル | ≈ 30% | 適度なリスク |
| 6セル | ≈ 52% | 分散投資時。被害率は高いが1セルあたりの損失は小 |

---

## ショップでの加護出現

加護付与はブロックセットのサイズによって確率が異なる。パターン・シールとは独立して判定される。

| サイズ | 対象ミノカテゴリ | パターン付与確率 | シール付与確率 | 加護付与確率 |
|--------|----------------|--------------|--------------|-------------|
| small | モノミノ/ドミノ/トリミノ | 0% | 0% | 0% |
| medium | テトロミノ/ペントミノ | 中確率 | 低確率 | 低確率 |
| large | ペントミノ/ヘキソミノ | 高確率 | 中確率 | 低〜中確率 |

- 付与される加護の種類はショップ出現可能なものからランダムに選択
- 加護はピース中の1ブロックにのみ付与される
- シールと同じブロックに付与されることもある

---

## スコア計算フローへの影響

既存のA×B方式に加護の効果が加わる:

```
1. 消去対象セルを収集（filterClearableCells でフィルタリング）
2. 加護効果を計算 ← NEW
   - 各消去セルについて、そのセルに加護があるか確認
   - power: ブロック点(A)に +Lv 加算
   - gold: ゴールドに +Lv 加算（スコア計算外）
   - chain: 列点(B)に +Lv 加算
   - guide: そのセルのパターン効果を +Lv 段階強化
   - heal: 確率で手数+1（スコア計算外）
3. パターン効果を計算（guide加護による強化込み）
4. シール効果を計算
5. レリック効果を計算
6. 最終スコア = Math.floor(A × B)
```

---

## 視覚表現

### 盤面上の加護表示

| 状態 | 表現 |
|------|------|
| 空きセル + 加護Lv1 | セル背景に淡いシンボル |
| 空きセル + 加護Lv2 | やや明るいシンボル |
| 空きセル + 加護Lv3 | はっきりしたシンボル + 微かな光 |
| ブロックが乗っている + 加護 | セルの縁取りが光る（Lvで明るさ変化） |
| obstacleが乗っている + 加護 | 加護マーカーが暗く表示（封印状態） |

### ブロック上の加護マーク

- シールと同様にブロック上にシンボル表示
- シールとは色味やデザインで区別する（シール = 即時感のある色、加護 = 永続感のある落ち着いた色）

---

## 関連ファイル（実装時の想定）

- `src/lib/game/Domain/Effect/Blessing.ts` — 加護定義・マスターデータ
- `src/lib/game/Domain/Effect/BlessingEffectHandler.ts` — 加護効果計算（純粋関数）
- `src/lib/game/Domain/Board/Cell.ts` — Cell構造にblessing/blessingLevelプロパティ追加
- `src/lib/game/Services/LineService.ts` — スコア計算に加護効果を統合
- `src/lib/game/Services/ShopService.ts` — ショップ商品生成・加護付与確率
- `src/lib/game/Services/BoardService.ts` — 消去時の加護セル反映処理

---

## 更新履歴

- 2026-02-20: 初版作成
