# スコア獲得演出の改善 - Balatro風カウンター表示

## ステータス: 導入推奨

Balatroの「Chips × Mult」カウンターを参考に、現在のスコアアニメーションを
「ブロック点 × 列点」の常設カウンター + 効果ごとの逐次加算演出に改善する。

---

## 参考元の分析

### Balatroの「Chips × Mult」スコア演出

**概要**:
- 画面下部に常時 `Chips × Mult` の2つの大きなカウンターが表示
- カードを出すと、各カードが左から順に光り、Chipsに加算される
- その後ジョーカーが左から順に発動し、Chips/Multに加算or乗算される
- 数値がリアルタイムで変動し、最終的に `Chips × Mult` が得点になる

**ゲームデザイン的意義**:
- **因果関係の可視化**: どの効果が数値を変えたか一目瞭然
- **期待感の創出**: 「次はどの効果が発動するか」の逐次演出
- **数値成長の快感**: 数字がどんどん大きくなる視覚的な気持ちよさ（特に乗算のジャンプ）
- **学習効果**: 効果の仕組みをプレイしながら自然に理解できる

**機能するための前提条件**:
- A×B の2軸のスコア計算構造
- 複数の加算/乗算ソース（カード、ジョーカー = 本ゲームのパターン/シール/レリック）
- 各ソースの発動を逐次表示できるタイミング制御

---

## 自ゲームの現状

### 現在の演出の課題

1. **常設表示がない**: 通常時に `ブロック点 × 列点` が見えず、スコア計算の仕組みが直感的にわからない
2. **式文字列で表現**: `(48) × 2` のような文字列表示で、A/Bの変動が視覚的にわかりにくい
3. **小さなテキスト**: ステータスパネル左端の13-16pxテキストで視認性が低い
4. **効果のソースが不明確**: どのブロック/レリックが効果を発揮しているかが伝わらない
5. **数字の変動感がない**: ステップが切り替わるだけで「数字が増えていく」快感がない

### 活用できる既存資産

- `FormulaStep` の段階的ステップ構造
- `highlightedRelicId` によるレリックパネルのハイライト機構
- 消去アニメーションの `effectLabel` 表示
- 早送り機能 (`isFastForward`)

---

## 分析

### 意思決定の質
スコア演出自体はプレイヤーの意思決定を直接生まないが、
「どの効果がスコアに貢献しているか」を可視化することで、
デッキ構築やレリック選択の意思決定の質が向上する。

### テンポへの影響
- **懸念**: 逐次演出でテンポが遅くなる可能性
- **対策**: ステップ間隔を短め (300-500ms) に設定 + タップで即完了の早送り
- **結論**: 適切な速度設定とスキップ機能があればテンポを損なわない

### 適合性
- 自ゲームの `A×B方式` はBalatroの `Chips × Mult` と構造が完全に一致
- パターン/シール/バフ/レリックの4種の効果ソースが、Balatroの「カード＋ジョーカー」に相当
- レリックパネルのハイライト機構が既にあり、拡張しやすい

---

## 判断

### 結論: 導入推奨

理由:
1. 自ゲームのスコア計算構造がBalatroと同一（A×B方式）で、完全に適合する
2. 効果の可視化により、デッキ構築の戦略性理解が深まる
3. 数値の段階的成長がプレイの満足感を大幅に向上させる
4. 既存のFormulaStepやhighlightedRelicId等の機構を活用できる

---

## 具体的な導入案

### 1. 常設カウンター表示

ステータスパネルのラウンドスコア下に、2つの大きなカウンターを常設:

```
  ┌──────────┐     ┌──────────┐
  │    12    │  ×  │    3     │
  │ ブロック点 │     │   列点   │
  └──────────┘     └──────────┘
```

- **通常時**: `0 × 0`（薄いグレー表示）
- **スコアリング中**: 数字が明るく活性化
- ブロック点の枠: 青系（Balatroの Chips カラー風）
- 列点の枠: 赤系（Balatroの Mult カラー風）

### 2. 効果の逐次適用演出

ライン消滅時のタイムライン:

| Phase | タイミング | 演出内容 |
|-------|----------|---------|
| 基本値 | 消去アニメ開始 | カウンターが `0→基本値` にカウントアップ |
| パターン | ~300ms後 | ブロック点が増加 + 効果名ラベル |
| バフ(A側) | ~600ms後 | ブロック点が増加 + 効果名ラベル |
| シール | ~900ms後 | ブロック点が増加 + 効果名ラベル |
| レリック加算 | ~1200ms後 | ブロック点が増加 + レリックアイコン光る |
| lucky | ~1500ms後 | 列点が×2 + 特別エフェクト |
| バフ(B側) | ~1800ms後 | 列点が増加 + 効果名ラベル |
| レリック列加算 | ~2100ms後 | 列点が増加 + レリックアイコン光る |
| レリック乗算 | ~2400ms後 | 列点が×N + 大きなポップ + レリックアイコン光る |
| 最終結果 | ~2700ms後 | A × B = 結果 → ラウンドスコアに加算 |

※ 効果がない場合はスキップされるため、実際の所要時間は短くなる

### 3. 数値変動の視覚効果

- **加算時**: カウンター数字がポップ (scale 1.0 → 1.3 → 1.0, 200ms)
- **乗算時**: 大きなポップ + 色変化 (scale 1.0 → 1.5 → 1.0, 300ms)
- **効果名**: カウンター付近に小さくフェードイン → フェードアウト
  - 例: 「エンハンスド +4」「連鎖の達人 ×1.5」

### 4. レリック発動のハイライト

- レリック効果適用時に、レリックパネルの対応アイコンが光る
- 既存の `highlightedRelicId` 機構を活用
- ステップごとに該当レリックIDをセット → ハイライト描画

### 5. 早送り/スキップ

- 画面タップで早送り（ステップ間隔を100msに短縮）
- 2回目のタップで即完了（全効果を一気に適用 → 最終結果表示）

---

## 必要な変更箇所

### データ構造
- `FormulaStep` に `blockPoints`, `linePoints` の数値を追加
- `ScoreAnimationState` にカウンター状態（ポップアニメーション等）を追加

### 描画
- `statusPanelRenderer.ts` にカウンター枠の常設描画を追加
- `scoreAnimationRenderer.ts` を大幅改修（テキスト式 → カウンターUI + 効果ラベル）

### ロジック
- `FormulaBuilder.ts` のステップ生成にA/B数値を含める
- `GameReducer` のアニメーション制御は基本的に既存構造を維持
