# ゲーム概要

## 概要

Wooden Puzzle 風デッキ構築パズルブラウザゲーム。プレイヤーはデッキから引いたブロック（ミノ）を6x6のボードに配置し、ラインを消去してスコアを獲得する。24ラウンド制で、各ラウンドで目標スコアを達成するとショップでデッキを強化できる。

## 基本情報

- **プラットフォーム**: ブラウザ（デスクトップ・モバイル対応）
- **操作方法**: マウス / タッチ操作 / キーボード（デバッグ）
- **技術スタック**: React + TypeScript、Canvas API
- **デバイス対応**: レスポンシブデザイン（画面サイズに応じたレイアウト調整）

## ゲームの目的

24ラウンド制のローグライト型パズルゲーム。各ラウンドで目標スコアを達成し、ショップでデッキを強化しながら最終ラウンドのクリアを目指す。

### ローグライト要素

Balatroのジョーカー中心設計に倣い、**レリックを戦略の主軸**に据える。ピースは「スコアを出す媒体」、レリックは「どう稼ぐかの戦略」、加護・護符は「デッキの質を調整する戦術」。

| 要素 | 役割 |
|---|---|
| レリック | 戦略の主軸。常駐効果でスコアの出し方を決める |
| ピース | スコアを出す媒体。レリック効果の発動条件 |
| 加護 | ピースに付与され、消去時にセルにバフを刻む |
| 護符 | デッキの質を変える消費アイテム |

- **レリック**: 恒久的なパッシブ効果を持つアイテム。所持上限5枠、売買可能（52種類実装済み）
- **加護（Blessing）**: ピースに付与され、消去時にセルにバフ効果を付与（4種類）
- **バフ（Buff）**: セルに刻まれる永続効果（増強、金鉱、脈動、透過）
- **デッキビルディング**: ラウンドクリア後にショップで新しいブロックをデッキに追加
- **ラウンドセット**: 雑魚→エリート→ボスの3ラウンドを1セットとして進行
- **パターン・シール**: ブロックに特殊効果を付与
- **護符（Amulet）**: デッキの質を調整する消費アイテム（ストック可能、最大2個）
- **ゴールドシステム**: ラウンドクリア報酬でショップアイテムを購入

## 基本ルール

### ボード

- 6x6のグリッド形式のボード
- 各セルは「空」または「埋まっている」の2状態
- セルにはパターン・シール・バフ情報が含まれる
- ボードは木目調のビジュアルスタイルで表示される
- 各ラウンド開始時にボードはリセットされる

### デッキシステム

- ゲーム開始時に初期デッキ（6枚: モノミノ1 + ドミノ2 + トロミノ3）が作成される
- デッキからランダムに3つのミノが手札として配られる
- ミノを配置すると残り配置回数が減少する
- 手札3つが全て空になると、デッキから新たに3つ引かれる
- デッキが足りない場合は自動的にシャッフルして引き直す
- 各ラウンドで配置可能な回数（12ハンド）が設定されている
- 初期デッキ6枚 / 12ハンド = 2周回転。護符で強化したピースを2回使える

### ミノ（ブロック）

- 画面下部に3つのブロックスロットが配置されている
- 各スロットには異なる形状のミノが配置される
- ミノは6種類のカテゴリに分類される:
  - モノミノ: 1セル
  - ドミノ: 2セル
  - トロミノ: 3セル
  - テトロミノ: 4セル
  - ペントミノ: 5セル
  - ヘキソミノ: 6セル
- 全307種類のミノ定義が存在（回転・反転を含む）

### ミノ配置

- ミノをドラッグしてボード上に移動できる
- 配置可能な位置では半透明茶色のプレビューが表示される
- 配置不可能な位置では半透明赤色のプレビューが表示される
- ドロップ時に配置可能であればミノがボードに配置され、スロットから削除される
- 配置不可能な場合はミノが元のスロットに戻る
- ミノを配置すると残り配置回数が1減少する
- 羽（feather）パターン付きブロックは既存ブロックに重ねて配置可能

### ストックシステム

- ボード左側に最大2つのストック枠が配置されている
- ストック枠にミノを一時保管できる（`hand_stock` レリック用機能）
- ストック1（`stockSlot`）と ストック2（`stockSlot2`）の2スロット構成
- ストック2は `hand_stock` レリックをコピーした場合に有効化される
- 手札からストックへの移動、ストックから手札への移動、手札とストックの交換が可能

### 加護（Blessing）システム

**加護**は、ピースに付与される特殊効果で、そのピースが配置された後、ブロックが消去される際にセルに**バフ**として刻み込まれる。

#### 加護の種類（4種類）

| 加護 | 説明 | バフ効果 | 最大レベル |
|---|---|---|---|
| 力の加護 | 消滅時にセルに増強を付与 | ブロック点+0.5 × LV | 3 |
| 金の加護 | 消滅時にセルに金鉱を付与 | LV/4 の確率で+1G | 3 |
| 連の加護 | 消滅時にセルに脈動を付与 | 列点+0.2 × LV | 3 |
| 透の加護 | 消滅時に25%の確率でセルに透過を付与 | そのセルを消さずにライン揃う | 1 |

#### 加護とバフの関係

```
ピースに加護付与 → ピース配置 → ブロック消去時 → セルにバフ刻印 → 以降のライン消去で効果発動
```

- 加護付きピースの購入価格は加護レベル × 3G 上昇する
- ショップでの加護付与確率は15%
- 複数レベルの加護が同じセルに重なった場合、レベルが加算される（最大レベルまで）

詳細は[加護システム](./blessing-system.md)を参照。

### ライン消去とスコア

- 行または列のすべてのセルが埋まると、そのラインが消去される
- 複数のラインを同時に消去できる（行と列の両方）
- ライン消去時にアニメーション（回転・上昇・縮小）が表示される
- スコアは画面上部中央に表示される

#### 消去対象外

以下のセルはライン消去の対象外:
- **石シール付きセル**: 消えない
- **おじゃまブロック**: 消えない（ボス条件で配置）
- **透過バフ付きセル**: 消えないが、ライン判定には含まれる

#### スコア計算

基本計算式:
```
獲得スコア = (消去されたブロック数 + ボーナス) × 消去されたライン数
```

**ボーナス**:
- 強化パターン: ブロック点+2
- バフ（増強）: ブロック点+0.5 × LV
- チャージパターン: 蓄積した値分ブロック点に加算
- レリック効果: サイズボーナス、パターンボーナス等
- マルチシール: ブロックが2回カウントされる

詳細は[パターンシステム](./pattern-system.md)、[シールシステム](./seal-system.md)、[レリックシステム](./relic-system.md)を参照。

### ラウンドシステム

- 全24ラウンド構成（3ラウンドで1セット、合計8セット）
- 各ラウンドには目標スコアが設定されている
- 目標スコアは画面上部中央に表示される
- 目標スコア達成でラウンドクリア
- 残り配置回数が0になると目標未達成でゲームオーバー
- 最終ラウンドをクリアするとゲームクリア

#### ラウンドセット構成

3ラウンドで1セットを構成:
1. **雑魚ラウンド** (normal): 通常難易度、クリア報酬が最も低い
2. **エリートラウンド** (elite): やや高難易度、中程度のクリア報酬
3. **ボスラウンド** (boss): 特殊条件付き、クリア報酬が最も高い

#### ボス特殊条件

ボスラウンドでは以下のいずれかの特殊条件が適用される:
- **おじゃまブロック**: ランダムな1マスが最初から埋まっている（消去不可）
- **省エネ**: 配置可能数が通常より減少（25%減）
- **手札2枚**: 手札が2枚になる（通常3枚）

ボス条件は各セットに入る時に抽選され、同じセット内では固定。

#### ゴールド報酬

ラウンドクリア時のゴールド報酬は以下の計算式で決まる:
```
獲得ゴールド = ラウンドタイプ基本報酬 + 残りハンド数
```

基本報酬: normal = 1G、elite = 2G、boss = 5G

### ゴールドシステム

- ラウンドクリア時にラウンドタイプに応じたゴールドを獲得
- ゴールドシール付きブロック消去時: +1G獲得（treasure_hunterレリック所持時は+2G）
- 金鉱バフ付きセルのブロック消去時: 確率でゴールド獲得
- レリック売却時: 購入価格の半額を獲得
- ゴールドは画面左上に金色で表示される
- ゴールドはショップでミノ・レリック・護符の購入に使用される
- ゴールドは次のラウンドに持ち越される
- ゲームオーバー時にゴールドはリセット

### ショップ

- ラウンドクリア後にショップフェーズに移行（最終ラウンドを除く）

#### 商品構成

| 枠 | 内容 | 枠数 |
|---|---|---|
| ピース枠 | 小〜中サイズ / 中〜大サイズ | 2 |
| レリック/護符枠 | レリックと護符がランダムに混在 | 3 |
| **合計** | | **5** |

- レリック/護符枠の1つが30%の確率で護符に置換される
- 全商品の中から1つがランダムにセール対象となる（25%OFF）
- `jester`レリック所持時は全商品30%OFF

#### ブロックセット商品

通常のミノに加え、特殊効果付きブロックセットが販売される:
- **パターン付きブロック**: ブロックセット全体に特殊効果が付与（詳細は[パターンシステム](./pattern-system.md)を参照）
- **シール付きブロック**: 特定のセルに特殊効果が付与（詳細は[シールシステム](./seal-system.md)を参照）
- **加護付きブロック**: ブロックに加護が付与され、消去時にバフがセルに刻まれる

基本ミノ（パターン・シール・加護なし）:
- 価格はセル数に基づいて設定される

#### レリック商品

恒久的なパッシブ効果を持つアイテム:
- 未所持のレリックからランダムに表示（重複なし）
- レアリティ別の重み付きランダム選択（common: 70、uncommon: 25、rare: 5、epic: 0.3）
- 価格はレアリティによって異なる（common: 10G、uncommon: 15G、rare: 20G、epic: 25G）
- レリック5枠が埋まっている場合でもレリックは表示される（売却→購入の導線）
- `jester`レリック所持時は所持枠が4枠に減少する
- 詳細は[レリックシステム](./relic-system.md)および[レリック一覧](./relic-list.md)を参照

#### 護符商品

デッキの質を変える消費アイテム:
- レリック/護符枠に混在して出現（30%の確率でレリック枠を1つ置換）
- 4種類の護符が存在（sculpt、pattern_add、seal_add、vanish）
- 購入後はストック（最大2個）に保管される
- 使用タイミング: ショップフェーズ中、またはパズル中（ショップ中のみ実装済み）
- 詳細は[護符システム](./amulet-system.md)を参照

#### レリック売却

- ショップフェーズ中にいつでも所持レリックを売却可能
- 売却価格: 購入価格の半額（端数切り捨て）
- レリック5枠が満杯の場合、新たに購入するには既存レリックを1つ売却する必要がある

#### ショップリロール

- ショップ内の商品をゴールドを消費して引き直すことができる
- リロールコストは使用するたびに増加する（初回3G、+1G/回）
- `merchant`レリック所持時はリロール費用-2G
- レリック中心設計のため、リロールの価値は相対的に高い

#### 購入ルール

- 所持ゴールドが価格以上の場合のみ購入可能
- 購入済みアイテムは再購入不可
- 購入は必須ではない（何も買わずに進行可能）
- ショップを出ると次のラウンド進行画面に移行する

## ゲームフェーズ

### フェーズ一覧と遷移

```
round_progress → playing → round_clear → shopping → round_progress
                         ↘ game_over   → round_progress (リセット時)
                                       → playing     (リセット時)
              round_clear → game_clear → round_progress (リセット時)
                                       → playing     (リセット時)
```

### round_progress（ラウンド進行画面）

- ラウンド開始前に表示される画面
- 現在のセット内のラウンド構成（雑魚/エリート/ボス）がカード形式で表示される
- 各ラウンドのクリア状況・目標スコア・報酬が確認できる
- 「開始」ボタンを押すと `playing` フェーズに移行する
- ゲームオーバー・ゲームクリア後のリセット先にもなる

### playing（プレイ中）

- 通常のゲームプレイ状態
- ミノの配置とライン消去が可能
- 目標スコア達成で `round_clear` へ遷移
- 残り配置回数が0かつ目標未達成で `game_over` へ遷移

### round_clear（ラウンドクリア）

- 目標スコア達成時に自動的に遷移
- ゴールド獲得演出が表示される
- 最終ラウンドでなければ `shopping` へ、最終ラウンドであれば `game_clear` へ遷移

### shopping（ショップ）

- ミノ・レリック・護符の購入が可能
- レリックの売却が可能（購入価格の半額）
- 護符の使用が可能（ストック中の護符を選択 → 対象ピース選択 → 効果適用）
- 商品のリロールが可能（コスト増加式）
- 「ショップを出る」ボタンで `round_progress` フェーズに進む

### game_over（ゲームオーバー）

- 残り配置回数が0で目標未達成の場合に遷移
- 到達ラウンド、最終スコア、獲得ゴールドが表示される
- 「リセット」ボタンでゲーム再開（`round_progress` または `playing` へ遷移）

### game_clear（ゲームクリア）

- 最終ラウンド（24ラウンド）をクリアした場合に遷移
- 最終的な獲得ゴールドが表示される
- 「リセット」ボタンでゲーム再開（`round_progress` または `playing` へ遷移）

## 操作方法

### デスクトップ（マウス）

1. ブロックをクリック&ホールドする
2. マウスを移動してボード上の配置位置にドラッグする
3. マウスボタンを離してドロップする
4. ショップでミノをクリックして購入する
5. Shift + 1 でデバッグウィンドウの表示/非表示を切り替え

### モバイル（タッチ）

1. ブロックをタッチ&ホールドする
2. 指を移動してボード上の配置位置にドラッグする
3. 指を離してドロップする
4. ショップでミノをタップして購入する

### デバッグウィンドウ

- Shift + 1 キーでデッキの内容を表示/非表示
- デッキ内のミノIDと次に引かれるミノがハイライト表示される
- ゴールド・スコアの手動調整が可能
- レリックの付与・削除が可能
- パターン/シール/加護の付与確率調整が可能
- 開発・デバッグ用の機能

## ビジュアルスタイル

- 木目調のデザイン
- ボード背景: ダークブラウン
- セル背景: タン色
- ブロック: シエナ系の茶色（ハイライト・影付き）
- プレビュー: 半透明（茶色/赤）
- ゴールド表示: 金色
- オーバーレイ: 半透明黒背景
- パターン別の色分け（強化: ゴールド、ラッキー: グリーン、羽: ベージュ、ノーハンド: スカイブルー、チャージ: オレンジ）
- 加護別の色分け（力: 赤、金: 金色、連: 青、透: シアン）
- レアリティ別の色分け（common: グレー、uncommon: 緑、rare: 青、epic: 紫）

## 関連ファイル

- `src/lib/game/Domain/GameState.ts` - ゲーム状態型定義
- `src/lib/game/Domain/Round/GamePhase.ts` - ゲームフェーズ定義・遷移バリデーション
- `src/lib/game/Domain/Round/RoundTypes.ts` - ラウンド情報・ボス条件型定義
- `src/lib/game/Domain/Deck/DeckState.ts` - デッキ状態・ストックスロット型定義
- `src/lib/game/Domain/Player/PlayerState.ts` - プレイヤー状態（ゴールド、レリック、護符ストック）
- `src/lib/game/Domain/Effect/Relic.ts` - レリック定義（52種類）
- `src/lib/game/Domain/Effect/Blessing.ts` - 加護定義（4種類）
- `src/lib/game/Domain/Effect/Amulet.ts` - 護符定義（4種類）
- `src/lib/game/Domain/Effect/Pattern.ts` - パターン定義（6種類）
- `src/lib/game/Domain/Effect/Seal.ts` - シール定義（3種類）
- `src/lib/game/Data/Constants.ts` - ゲーム定数（グリッドサイズ、色定義、ラウンド設定等）
- `src/lib/game/Data/MinoDefinitions.ts` - ミノ形状定義（全307種類）
- `src/lib/game/Services/RoundService.ts` - ラウンド・ゴールド計算ロジック
- `src/lib/game/Services/DeckService.ts` - デッキ管理ロジック
- `src/lib/game/Services/ShopService.ts` - ショップロジック
- `src/lib/game/Services/LineService.ts` - ライン消去とスコア計算
- `src/lib/game/Data/BossConditions.ts` - ボス条件定義
- `src/lib/game/State/Actions/GameActions.ts` - 全アクション型定義
- `src/hooks/useGame.ts` - ゲーム状態管理
- `src/components/GameContainer.tsx` - ゲームコンテナコンポーネント
- `src/components/GameCanvas.tsx` - Canvas描画コンポーネント

## 更新履歴

- 2026-02-01: 初版作成
- 2026-02-01: ミノシステム、ライン消去、スコアシステムを追加
- 2026-02-02: デッキシステム、ラウンド制、ゴールド、ショップ、ゲームフェーズ、デバッグウィンドウを追加
- 2026-02-06: ローグライト要素追加（ラウンドセット、ボス条件、パターン・シール・レリック概要、ショップ拡張）
- 2026-02-09: ファイルパス更新（Domain/Service/State層への構造変更を反映）
- 2026-02-17: round_progressフェーズ追加、ストックシステム（2スロット）追加、フェーズ遷移図追加、ショップリロール追加、ゴールド報酬計算式追加、関連ファイルパス修正
- 2026-02-17: レリック中心設計を反映（ローグライト要素にレリック主軸/護符追加、デッキ6枚化、利息、ショップ2+3構成、レリック売却、護符商品）
- 2026-02-20: 加護（Blessing）/バフ（Buff）システムを追加、レリック52種に更新、パターン6種・シール3種に更新、ショップ仕様を最新実装に同期（セール、jester割引、護符30%出現）、未実装の注記を削除
