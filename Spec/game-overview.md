# ゲーム概要

## 概要

Wooden Puzzle 風デッキ構築パズルブラウザゲーム。プレイヤーはデッキから引いたブロック（ミノ）を6x6のボードに配置し、ラインを消去してスコアを獲得する。24ラウンド制で、各ラウンドで目標スコアを達成するとショップでデッキを強化できる。

## 基本情報

- **プラットフォーム**: ブラウザ（デスクトップ・モバイル対応）
- **操作方法**: マウス / タッチ操作 / キーボード（デバッグ）
- **技術スタック**: React + TypeScript、Canvas API
- **デバイス対応**: レスポンシブデザイン（画面サイズに応じたレイアウト調整）

## ゲームの目的

24ラウンド制のローグライト型パズルゲーム。各ラウンドで目標スコアを達成し、ショップでデッキを強化しながら最終ラウンドのクリアを目指す。

### ローグライト要素

- **デッキビルディング**: ラウンドクリア後にショップで新しいブロックをデッキに追加
- **ラウンドセット**: 雑魚→エリート→ボスの3ラウンドを1セットとして進行
- **パターン・シール**: ブロックに特殊効果を付与
- **レリック**: 恒久的なパッシブ効果を持つアイテム
- **ゴールドシステム**: ラウンドクリア報酬でショップアイテムを購入

## 基本ルール

### ボード

- 6x6のグリッド形式のボード
- 各セルは「空」または「埋まっている」の2状態
- ボードは木目調のビジュアルスタイルで表示される
- 各ラウンド開始時にボードはリセットされる

### デッキシステム

- ゲーム開始時に初期デッキが作成される
- デッキからランダムに3つのミノが手札として配られる
- ミノを配置すると残り配置回数が減少する
- 手札3つが全て空になると、デッキから新たに3つ引かれる
- デッキが足りない場合は自動的にシャッフルして引き直す
- 各ラウンドで配置可能な回数が設定されている

### ミノ（ブロック）

- 画面下部に3つのブロックスロットが配置されている
- 各スロットには異なる形状のミノが配置される
- ミノは6種類のカテゴリに分類される:
  - モノミノ: 1セル
  - ドミノ: 2セル
  - トロミノ: 3セル
  - テトロミノ: 4セル
  - ペントミノ: 5セル
  - ヘキソミノ: 6セル
- 全307種類のミノ定義が存在（回転・反転を含む）

### ミノ配置

- ミノをドラッグしてボード上に移動できる
- 配置可能な位置では半透明茶色のプレビューが表示される
- 配置不可能な位置では半透明赤色のプレビューが表示される
- ドロップ時に配置可能であればミノがボードに配置され、スロットから削除される
- 配置不可能な場合はミノが元のスロットに戻る
- ミノを配置すると残り配置回数が1減少する

### ストックシステム

- ボード左側に最大2つのストック枠が配置されている
- ストック枠にミノを一時保管できる（`hand_stock` レリック用機能）
- ストック1（`stockSlot`）と ストック2（`stockSlot2`）の2スロット構成
- ストック2は `hand_stock` レリックをコピーした場合に有効化される
- 手札からストックへの移動、ストックから手札への移動、手札とストックの交換が可能

### ライン消去とスコア

- 行または列のすべてのセルが埋まると、そのラインが消去される
- 複数のラインを同時に消去できる（行と列の両方）
- ライン消去時にアニメーション（回転・上昇・縮小）が表示される
- スコアは画面上部中央に表示される

#### 消去対象外

以下のセルはライン消去の対象外:
- **石シール付きセル**: 消えない
- **おじゃまブロック**: 消えない（ボス条件で配置）

#### スコア計算

基本計算式:
```
獲得スコア = (消去されたブロック数 + ボーナス) × 消去されたライン数
```

**ボーナス**:
- オーラ効果: 隣接するオーラブロック（別セット）があるセルは+1
- 苔効果: 盤面端と接している辺の数だけ+1
- レリック効果（連鎖の達人）: 複数ライン同時消去で倍率適用

詳細は[パターン・シールシステム](./pattern-seal-system.md)と[レリックシステム](./relic-system.md)を参照。

### ラウンドシステム

- 全24ラウンド構成（3ラウンドで1セット、合計8セット）
- 各ラウンドには目標スコアが設定されている
- 目標スコアは画面上部中央に表示される
- 目標スコア達成でラウンドクリア
- 残り配置回数が0になると目標未達成でゲームオーバー
- 最終ラウンドをクリアするとゲームクリア

#### ラウンドセット構成

3ラウンドで1セットを構成:
1. **雑魚ラウンド** (normal): 通常難易度、クリア報酬が最も低い
2. **エリートラウンド** (elite): やや高難易度、中程度のクリア報酬
3. **ボスラウンド** (boss): 特殊条件付き、クリア報酬が最も高い

#### ボス特殊条件

ボスラウンドでは以下のいずれかの特殊条件が適用される:
- **おじゃまブロック**: ランダムな1マスが最初から埋まっている（消去不可）
- **省エネ**: 配置可能数が通常より減少
- **手札2枚**: 手札が2枚になる（通常3枚）

ボス条件は各セットに入る時に抽選され、同じセット内では固定。

#### ゴールド報酬

ラウンドクリア時のゴールド報酬は以下の計算式で決まる:
```
獲得ゴールド = ラウンドタイプ基本報酬 + 残りハンド数
```

### ゴールドシステム

- ラウンドクリア時にラウンドタイプに応じたゴールドを獲得
- ゴールドシール付きブロック消去時: 追加ゴールド獲得
- ゴールドは画面左上に金色で表示される
- ゴールドはショップでミノやレリックの購入に使用される
- ゴールドは次のラウンドに持ち越される
- ゲームオーバー時にゴールドはリセット

### ショップ

- ラウンドクリア後にショップフェーズに移行（最終ラウンドを除く）

#### ブロックセット商品

通常のミノに加え、特殊効果付きブロックセットが販売される:
- **パターン付きブロック**: ブロックセット全体に特殊効果が付与（詳細は[パターン・シールシステム](./pattern-seal-system.md)を参照）
- **シール付きブロック**: 特定のセルに特殊効果が付与（詳細は[パターン・シールシステム](./pattern-seal-system.md)を参照）

基本ミノ（パターン・シールなし）:
- 小サイズ: モノミノ/ドミノ/トロミノから1つ
- 中サイズ: テトロミノ/ペントミノから1つ
- 大サイズ: ペントミノ/ヘキソミノから1つ
- 価格はセル数に基づいて設定

#### レリック商品

恒久的なパッシブ効果を持つアイテム:
- 未所持のレリックからランダムに表示
- 価格はレアリティによって異なる
- 詳細は[レリックシステム](./relic-system.md)を参照

#### ショップリロール

- ショップ内の商品をゴールドを消費して引き直すことができる
- リロールコストは使用するたびに増加する

#### 購入ルール

- 所持ゴールドが価格以上の場合のみ購入可能
- 購入済みアイテムは再購入不可
- 購入は必須ではない（何も買わずに進行可能）
- ショップを出ると次のラウンド進行画面に移行する

## ゲームフェーズ

### フェーズ一覧と遷移

```
round_progress → playing → round_clear → shopping → round_progress
                         ↘ game_over   → round_progress (リセット時)
                                       → playing     (リセット時)
              round_clear → game_clear → round_progress (リセット時)
                                       → playing     (リセット時)
```

### round_progress（ラウンド進行画面）

- ラウンド開始前に表示される画面
- 現在のセット内のラウンド構成（雑魚/エリート/ボス）がカード形式で表示される
- 各ラウンドのクリア状況・目標スコア・報酬が確認できる
- 「開始」ボタンを押すと `playing` フェーズに移行する
- ゲームオーバー・ゲームクリア後のリセット先にもなる

### playing（プレイ中）

- 通常のゲームプレイ状態
- ミノの配置とライン消去が可能
- 目標スコア達成で `round_clear` へ遷移
- 残り配置回数が0かつ目標未達成で `game_over` へ遷移

### round_clear（ラウンドクリア）

- 目標スコア達成時に自動的に遷移
- ゴールド獲得演出が表示される
- 最終ラウンドでなければ `shopping` へ、最終ラウンドであれば `game_clear` へ遷移

### shopping（ショップ）

- ミノ・レリックの購入が可能
- 「ショップを出る」ボタンで `round_progress` フェーズに進む

### game_over（ゲームオーバー）

- 残り配置回数が0で目標未達成の場合に遷移
- 到達ラウンド、最終スコア、獲得ゴールドが表示される
- 「リセット」ボタンでゲーム再開（`round_progress` または `playing` へ遷移）

### game_clear（ゲームクリア）

- 最終ラウンド（24ラウンド）をクリアした場合に遷移
- 最終的な獲得ゴールドが表示される
- 「リセット」ボタンでゲーム再開（`round_progress` または `playing` へ遷移）

## 操作方法

### デスクトップ（マウス）

1. ブロックをクリック&ホールドする
2. マウスを移動してボード上の配置位置にドラッグする
3. マウスボタンを離してドロップする
4. ショップでミノをクリックして購入する
5. Shift + 1 でデバッグウィンドウの表示/非表示を切り替え

### モバイル（タッチ）

1. ブロックをタッチ&ホールドする
2. 指を移動してボード上の配置位置にドラッグする
3. 指を離してドロップする
4. ショップでミノをタップして購入する

### デバッグウィンドウ

- Shift + 1 キーでデッキの内容を表示/非表示
- デッキ内のミノIDと次に引かれるミノがハイライト表示される
- ゴールド・スコアの手動調整が可能
- レリックの付与・削除が可能
- 開発・デバッグ用の機能

## ビジュアルスタイル

- 木目調のデザイン
- ボード背景: ダークブラウン
- セル背景: タン色
- ブロック: シエナ系の茶色（ハイライト・影付き）
- プレビュー: 半透明（茶色/赤）
- ゴールド表示: 金色
- オーバーレイ: 半透明黒背景

## 関連ファイル

- `src/lib/game/Domain/GameState.ts` - ゲーム状態型定義
- `src/lib/game/Domain/Round/GamePhase.ts` - ゲームフェーズ定義・遷移バリデーション
- `src/lib/game/Domain/Round/RoundTypes.ts` - ラウンド情報・ボス条件型定義
- `src/lib/game/Domain/Deck/DeckState.ts` - デッキ状態・ストックスロット型定義
- `src/lib/game/Data/Constants.ts` - ゲーム定数（グリッドサイズ、色定義、ラウンド設定等）
- `src/lib/game/Data/MinoDefinitions.ts` - ミノ形状定義（全307種類）
- `src/lib/game/Services/RoundService.ts` - ラウンド・ゴールド計算ロジック
- `src/lib/game/Services/DeckService.ts` - デッキ管理ロジック
- `src/lib/game/Services/ShopService.ts` - ショップロジック
- `src/lib/game/Services/LineService.ts` - ライン消去とスコア計算
- `src/lib/game/Data/BossConditions.ts` - ボス条件定義
- `src/lib/game/State/Actions/GameActions.ts` - 全アクション型定義
- `src/hooks/useGame.ts` - ゲーム状態管理
- `src/components/GameContainer.tsx` - ゲームコンテナコンポーネント
- `src/components/GameCanvas.tsx` - Canvas描画コンポーネント

## 更新履歴

- 2026-02-01: 初版作成
- 2026-02-01: ミノシステム、ライン消去、スコアシステムを追加
- 2026-02-02: デッキシステム、ラウンド制、ゴールド、ショップ、ゲームフェーズ、デバッグウィンドウを追加
- 2026-02-06: ローグライト要素追加（ラウンドセット、ボス条件、パターン・シール・レリック概要、ショップ拡張）
- 2026-02-09: ファイルパス更新（Domain/Service/State層への構造変更を反映）
- 2026-02-17: round_progressフェーズ追加、ストックシステム（2スロット）追加、フェーズ遷移図追加、ショップリロール追加、ゴールド報酬計算式追加、関連ファイルパス修正
